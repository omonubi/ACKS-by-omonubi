<!-- Tab Controls -->
<div class='page-title'>
    <h1><img src='https://files.d20.io/images/365102791/eyJcpNMeNGuh5AxYBLtf1Q/original.png?16984447805'/> Adventurer Conqueror King System</h1>
</div>
<div class='button-panel'>
    <input type='hidden' class='buttonstoggle' name='attr_sheetButtons' value='overview'/>
    <button type='action' class='btnOverview' name='act_overview' >Overview</button> 
    <button type='action' class='btnClass' name='act_class' >Class</button>
    <input type='hidden' class='hideStudious' value='0' name='attr_show_studious'/>
    <button type='action' class='btnStudious' name='act_studious' >Studious</button>
    <input type='hidden' class='hidePrayerful' value='0' name='attr_show_prayerful'/>
    <button type='action' class='btnPrayerful' name='act_prayerful' >Prayerful</button>
    <button type='action' class='btnCombat' name='act_combat' >Combat</button>
    <button type='action' class='btnSkills' name='act_skills' >Skills</button>  
    <button type='action' class='btnEquipment' name='act_equipment' >Equip</button>
    <button type='action' class='btnWealth' name='act_wealth' >Wealth</button>   
    <button type='action' class='btnHirelings' name='act_hirelings' >Hirelings</button>
    <button type='action' class='btnJournal' name='act_journal' >Journal</button>
    <button type='action' class='btnSettings' name='act_settings' >Settings</button>
    <div class='whispertoggle'>
        <label>whisper</label>
        <input type='checkbox' title='Check to whisper all outputs to R20 Chat.' name='attr_toggle_whisper' />
        <input type='hidden' name='attr_whispertoggle'/>
    </div>
</div>

<!-- Tracks sheet upgrade version to fire events on first sheet:opened() -->
<input type='hidden' name='attr_sheet_version' value='0'/>

<input type='hidden' class='tabstoggle' name='attr_sheetTab' value='overview'/>
<!-- Character Sheet -->
<section class='overview'>
    <div class='grid-2column'>
        <div class='grid-overview'>
            <label>Character Name</label><input type='text' title='@{character_fullname}' name='attr_character_fullname' />
            <label>Class <span title='Select from the list or enter a custom value.'>(?)</span></label><input type='text' list='classes' title='@{class}' name='attr_class'/>
            <datalist id='classes'>
                <option>Assassin</option>
                <option>Barbarian</option>
                <option>Bard</option>
                <option>Bladedancer</option>
                <option>Crusader</option>
                <option>Dwarven Craftpriest</option>
                <option>Dwarven Vaultguard</option>
                <option>Elven Nightblade</option>
                <option>Elven Spellsword</option>
                <option>Explorer</option>
                <option>Fighter</option>
                <option>Mage</option>
                <option>Nobiran Wonderworker/option>
                <option>Paladin</option>
                <option>Priestess</option>
                <option>Shaman</option>
                <option>Thief</option>
                <option>Venturer</option>
                <option>Warlock</option>
                <option>Witch</option>
                <option>Zaharan Ruinguard</option>
            </datalist>
            <label>Title <span title="The character's title, if any. Appears in all roll outputs.">(?)</span></label><input type='text' title='@{character_title}' name='attr_character_title'/> 
            <label>Alignment <span title='Select from the list or enter a custom value.'>(?)</span></label><input type='text' title='@{alignment}' name='attr_alignment' list='alignments'/> 
            <datalist id='alignments'>
                <option>Lawful</option>
                <option>Neutral</option>
                <option>Chaotic</option>
            </datalist>
            <div class='xplabel'><label class='xp'>Experience (+<span class='xpbonus' title='@{xp_bonus}' name='attr_xp_bonus'>0</span><span>%)</span> <span title='Current (computed) XP / XP neeeded for next level. The bonus is computed based on Key Attributes, below.'>(?)</span></label></div>
                <div>
                    <input class='xp' type='text' value='0' title='@{xp}' name='attr_xp' readonly/> / 
                    <input class='xp' type='text' value='0' title='@{xp_next_level}' name='attr_xp_next_level'/>
                </div>
            <label>Level</label>
                <input type='number' min='0' max='14' value='1' title='@{level}' name='attr_level' />
                <input type='hidden' name='attr_max_level'/>
        </div>
        <div class='grid-overview'>
            <label>Token Name</label><input type='text' title='@{character_name}' name='attr_character_name' />
            <label>Gender</label><input type='text' title='@{gender}' name='attr_gender'/>              
            <label>Height</label><input type='text' title='@{height}' name='attr_height'/>           
            <label>Weight</label><input type='text' title='@{weight}' name='attr_weight'/>
            <label>Age</label><input type='number' title='@{age}' name='attr_age' />
            <label>Hit Dice <span title="Format must be '#d#', with an optional '+/-' and a number. E.G. 2d8, 1d8-1, 9d6+2.">(?)</span></label>
            <div>
                <input type='hidden' class='hdcheck' name='attr_isBadHDFormula'/>
                <input class='redhd' type='text' title='@{hit_dice}' name='attr_hit_dice' />
                <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_hd} **Hit Dice Roll**}} {{color=green}} {{subtitle=@{character_title} @{selected|token_name}}} {{Hit Dice=@{hit_dice}}} {{Roll=[[@{hit_dice}+(@{con_mod}[con]*@{numHD}[#HD])]]}}' name='roll_hit_dice'> Hit Dice</button>
                <input type='hidden' name='attr_numHD'/>
            </div>
        </div>
        <hr class='spangrid'/>
        <div class='grid-attributes'>
            <label class='span-header'>Attribute Scores</label>
            <label></label>
            <label>Current <span title='Tracks current attribute scores.'>(?)</span></label>
            <label>Max <span title='Tracks unmodified, baseline attribute scores via Settings tab.'>(?)</span></label>
            <label>Mod <span title='Computer attribute modifier.'>(?)</span></label>
            <label>Key <span title='The Class key attribute(s) used to determine XP bonus.'>(?)</span></label>
            <label class='attrname'>Strength <span title='Affects melee/thrown attack throws, damage rolls, and Dungeonbashing.'>(?)</span></label>
            <input type='number' value='10' min='0' max='20' title='@{str}' name='attr_str' />
            <input type='number' value='10' title='@{str_max}' name='attr_str_max' readonly/>
            <input type='number' value='0' title='@{str_mod}' name='attr_str_mod' readonly />
            <input type='checkbox' value='1' title='@{str_pre}' name='attr_str_pre'/>
            <label class='attrname'>Intellect <span title='Affects number of general proficiencies, languages spoken, and spell slots per day.'>(?)</span></label>
            <input type='number' value='10' min='0' max='20' title='@{int}' name='attr_int' />
            <input type='number' value='10' title='@{int_max}' name='attr_int_max' readonly/>
            <input type='number' value='0' title='@{int_mod}' name='attr_int_mod' readonly />
            <input type='checkbox' value='1' title='@{int_pre}' name='attr_int_pre'/>
            <label class='attrname'>Will <span title='Affects all saving throws.'>(?)</span></label>
            <input type='number' value='10' min='0' max='20' title='@{wil}' name='attr_wil' />
            <input type='number' value='10' title='@{wil_max}' name='attr_wil_max' readonly/>
            <input type='number' value='0' title='@{wil_mod}' name='attr_wil_mod' readonly />
            <input type='checkbox' value='1' title='@{wil_pre}' name='attr_wil_pre'/>            
            <label class='attrname'>Dexterity <span title='Affects all missile attack throws, AC, and initiative rolls.'>(?)</span></label>
            <input type='number' value='10' min='0' max='20' title='@{dex}' name='attr_dex' />
            <input type='number' value='10' title='@{dex_max}' name='attr_dex_max' readonly/>
            <input type='number' value='0' title='@{dex_mod}' name='attr_dex_mod' readonly />
            <input type='checkbox' value='1' title='@{dex_pre}' name='attr_dex_pre'/>
            <label class='attrname'>Constitution <span title='Affects each hit die rolled to generate hit points.'>(?)</span></label>
            <input type='number' value='10' min='0' max='20' title='@{con}' name='attr_con' />
            <input type='number' value='10' title='@{con_max}' name='attr_con_max' readonly/>
            <input type='number' value='0' title='@{con_mod}' name='attr_con_mod' readonly />
            <input type='checkbox' value='1' title='@{con_pre}' name='attr_con_pre'/>
            <label class='attrname'>Charisma <span title='Affects reaction rolls, henchmen limit, and henchmen rolls.'>(?)</span></label>
            <input type='number' value='10' min='0' max='20' title='@{cha}' name='attr_cha' />
            <input type='number' value='10' title='@{cha_max}' name='attr_cha_max' readonly/>
            <input type='number' value='0' title='@{cha_mod}' name='attr_cha_mod' readonly />
            <input type='checkbox' value='1' title='@{cha_pre}' name='attr_cha_pre'/>
        </div>
        <div class='grid-summary'>
            <label class='span-header'>Summary Stats</label>
            <label>Hit Points</label>
                <input type='hidden' class='hpcheck' name='attr_hp_is_below_one'/>
                <input class='redhp' type='number' value='0' title='@{hp}' name='attr_hp'/> 
            <label>HP Max</label>
                <input type='number' value='0' title='@{hp_max}' name='attr_hp_max'/>
            <label>Fatigue Level</label>
                <input type='hidden' class='fatiguecheck' name='attr_is_fatigued'/>
                <input class='redfatigue' type='number' value='0' min='0' title='@{fatigue}' name='attr_fatigue'/>
            <label>Bedrest Needed</label>
                <input type='hidden' class='bedrestcheck' name='attr_is_bedrest'/>
                <input class='redbedrest' type='number' value='0' min='0' title='@{bedrest}' name='attr_bedrest'/>
            <label>Armor Class</label>
                <input type='number' value='0' title='@{armor_class}' name='attr_armor_class' readonly/>
            <label>Attack Throw</label>
                <input type='number' value='10' title='@{attack throw}' name='attr_attack_throw' readonly/>
            <label>Encumbrance</label>
                <input type='hidden' class='encOverFive' name='attr_enc_over_five'/>
                <input class='orangeEnc' type='number' value='0' title='@{encumbrance}' name='attr_encumbrance' readonly />
            <label>Capacity, Max</label>
                <input type='number' value='20' title='@{enc_capacity}' name='attr_enc_capacity' readonly/>
            <label>Feet / Turn</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='120' title='@{move_turn}' name='attr_move_turn' readonly/> 
            <label>Feet / Round</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='40' title='@{move_round}' name='attr_move_round' readonly/>
            <label>Miles / Day</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='24' title='@{miles_day}' name='attr_miles_day' readonly/>
            <label>Miles / Hour</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='0.75' title='@{miles_hour}' name='attr_miles_hour' readonly/>
        </div>
        <hr class='spangrid'/>
        <div class='grid-savingthrows'>
            <label class='span-header'>Saving Throws</label>
            <span>
                <input class='smallWidth' type='text' maxlength='3' placeholder='Profile' title='@{save_profile}' name='attr_save_profile'/>
                <label><span title='Optional. OVERWRITES saving throw Base values, when XY format is entered. X values = [C, F, M, or T]. Y values = [0-14].'>(?)</span></label>
            </span>
            <label>Base</label>
            <label>Modifier <span title='Optional. A *negative* number that lowers the Base value to compute the Target.'>(?)</span></label>
            <label>Target</label>

            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_saveparalysis} **Saving Throw (Paralysis)**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=orange}} {{Target=[[@{save_1}]]}} {{Roll=[[1d20[die]+@{wil_mod}[wil]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_1'> Paralysis</button>
                <input type='number' min='1' max='20' value='13' title='@{save_1_base}' name='attr_save_1_base'/>
                <input type='number' min='-20' max='0' value='0' title='@{save_1_mod}' name='attr_save_1_mod'/>
                <input type='number' readonly title='@{save_1}' name='attr_save_1'/>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_savedeath} **Saving Throw (Death)**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=orange}} {{Target=[[@{save_2}]]}} {{Roll=[[1d20[die]+@{wil_mod}[wil]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_2'> Death</button>
                <input type='number' min='1' max='20' value='14' title='@{save_2_base}' name='attr_save_2_base'/>
                <input type='number' min='-20' max='0' value='0' title='@{save_2_mod}' name='attr_save_2_mod'/>
                <input type='number' readonly title='@{save_2}' name='attr_save_2'/>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_saveblast} **Saving Throw (Blast)**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=orange}} {{Target=[[@{save_3}]]}} {{Roll=[[1d20[die]+@{wil_mod}[wil]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_3'> Blast</button>
                <input type='number' min='1' max='20' value='15' title='@{save_3_base}' name='attr_save_3_base'/>
                <input type='number' min='-20' max='0' value='0' title='@{save_3_mod}' name='attr_save_3_mod'/>
                <input type='number' readonly title='@{save_3}' name='attr_save_3'/>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_saveimplements} **Saving Throw (Implements)**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=orange}} {{Target=[[@{save_4}]]}} {{Roll=[[1d20[die]+@{wil_mod}[wil]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_4'> Implements</button>
                <input type='number' min='1' max='20' value='16' title='@{save_4_base}' name='attr_save_4_base'/>
                <input type='number' min='-20' max='0' value='0' title='@{save_4_mod}' name='attr_save_4_mod'/>
                <input type='number' readonly title='@{save_4}' name='attr_save_4'/>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_savespells} **Saving Throw (Spells)**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=orange}} {{Target=[[@{save_5}]]}} {{Roll=[[1d20[die]+@{wil_mod}[wil]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_5'> Spells</button>
                <input type='number' min='1' max='20' value='17' title='@{save_5_base}' name='attr_save_5_base'/>
                <input type='number' min='-20' max='0' value='0' title='@{save_5_mod}' name='attr_save_5_mod'/>
                <input type='number' readonly title='@{save_5}' name='attr_save_5'/>
        </div>
        <div class='grid-monster'>
            <label class='span-header' title='Mainly used for monster-only stats.'>Monster Stats</label>
            <label>Alt Mode 1 <span title='Use to track an alternate form of monster movement.'>(?)</span></label> 
                <input class='smallWidth' type='text' title='@{alt_mode_1}' name='attr_alt_mode_1'/> 
            <label>Feet / Round</label> 
                <input class='smallWidth' type='text' title='@{alt_move_1}' name='attr_alt_move_1'/>
            <label>Alt Mode 2 <span title='Use to track an alternate form of monster movement.'>(?)</span></label> 
                <input class='smallWidth' type='text' title='@{alt_mode_2}' name='attr_alt_mode_2'/> 
            <label>Feet / Round</label> 
                <input class='smallWidth' type='text' title='@{alt_move_2}' name='attr_alt_move_2'/>
            <label>Alt Mode 3 <span title='Use to track an alternate form of monster movement.'>(?)</span></label> 
                <input class='smallWidth' type='text' title='@{alt_mode_3}' name='attr_alt_mode_3'/> 
            <label>Feet / Round</label> 
                <input class='smallWidth' type='text' title='@{alt_move_3}' name='attr_alt_move_3'/>
            <label>Morale</label>
                <input type='number' value='0' title='@{morale}' name='attr_morale'/>
            <label>XP Value</label>
                <input type='number' title='@{xp_value}' name='attr_xp_value' />
            <label>Size</label>
                <select class='sizeSelect' title='@{monster_size}' name='attr_monster_size'>
                    <option>Small</option>
                    <option selected>Medium</option>
                    <option>Large</option>
                    <option>Huge</option>
                    <option>Gigantic</option>
                    <option>Colossal</option>
                </select>
            <label>Treasure Type</label>
                <input class='smallWidth' type='text' maxlength='3' title='@{treasure_type}' name='attr_treasure_type'/>
        </div>
    </div>
    <hr/>
</section>

<section class='class'>
    <div>
        <label class='span-header'>Global Class Bonuses <span title='Use only for class-specific bonuses that are applied all the time.'>(?)</span></label>
        <div class='grid-classbonuses'>
            <label>Armor Class</label><input type='number' min='0' max='20' value='0' title='@{class_ac_bonus}' name='attr_class_ac_bonus'/>
            <label>Dmg, Melee</label><input type='number' min='-5' max='20' value='0' title='@{class_damage_bonus}' name='attr_class_damage_bonus'/>
            <label>Dmg, Missile</label><input type='number' min='-5' max='20' value='0' title='@{class_damage_bonus_missile}' name='attr_class_damage_bonus_missile'/>
            <label>Hire Loyalty</label><input type='number' min='0' max='20' value='0' title='@{class_hireling_loyalty_bonus}' name='attr_class_hireling_loyalty_bonus'/>
            <label>Initiative</label><input type='number' min='-5' max='20' value='0' title='@{class_initiative_bonus}' name='attr_class_initiative_bonus'/>
            <label>Saving Throws <span title='OVERWRITES values entered into Saving Throws > Modifier column.'>(?)</span></label><input type='number' min='0' max='20' value='0' title='@{class_save_bonus}' name='attr_class_save_bonus'/>
            <label>Surprise</label><input type='number' min='-5' max='20' value='0' title='@{class_surprise_bonus}' name='attr_class_surprise_bonus'/>
            <label>Hench Morale</label><input type='number' min='0' max='20' value='0' title='@{class_henchmen_morale_bonus}' name='attr_class_henchmen_morale_bonus'/>
        </div>
        <hr/>
        <label class='span-header'>Class Proficiencies</label>
        <div class='grid-classprof'>
            <label>Very Light Armor</label><input type='checkbox' value='1' title='@{class_ap_vlight}' name='attr_class_ap_vlight'/>
            <label>Light Armor</label><input type='checkbox' value='1' title='@{class_ap_light}' name='attr_class_ap_light'/>
            <label>Medium Armor</label><input type='checkbox' value='1' title='@{class_ap_medium}' name='attr_class_ap_medium'/>
            <label>Heavy Armor</label><input type='checkbox' value='1' title='@{class_ap_heavy}' name='attr_class_ap_heavy'/>

            <label>Single/Missile</label><input type='checkbox' checked/>
            <label>Dual Weapon</label><input type='checkbox' value='1' title='@{class_fs_dual}' name='attr_class_fs_dual'/>
            <label>Two-Handed Weapon</label><input type='checkbox' value='1' title='@{class_fs_2h}' name='attr_class_fs_2h'/>
            <label>Weapon & Shield</label><input type='checkbox' value='1' title='@{fs_weapshield}' name='attr_fs_weapshield'/>
        </div>
        <label>Weapon Proficiencies </label><input class='weaponProfs' type='text' title='@{wp}' name='attr_wp'/>
        <label>Class Template </label><input type='text' title='@{class_template}' name='attr_class_template'/>
        <hr/>
        <input type='hidden' class='hideCode' value='0' name='attr_show_behavior'/>
        <div class='code'>
            <label class='span-header'>Code of Behavior</label>
            <textarea class='background' placeholder='Enter details...' title='@{codeOfBehavior}' name='attr_codeOfBehavior'></textarea>
            <hr/>
        </div>
        <label class='span-header'>Class Description <span title='Intended to provide a player with a complete class description (copy/pasted from ACKS).'>(?)</span></label>
        <textarea placeholder='Enter details from ACKS rules reference...' title='@{class_abilities}' name='attr_class_abilities'></textarea>
        <hr/>
    </div>
</section>

<section class='combat'>
    <div class='grid-encounter-buttons'>
        <button type='roll' class='wideButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_init} **Initiative Roll**}} {{subtitle=@{character_title} @{selected|token_name}}} {{Roll=[[((1d6cs0cf0+@{dex_mod}[dex]+@{class_initiative_bonus}[class]+@{fss_single}[fss]+(@{mod_initiative}[mod1])+(?{Modifier|0}[mod2])))&{tracker}]]}}' name='roll_initiative'> Initiative</button>
        <button type='roll' class='wideButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_surprise} **Surprise Roll**}} {{subtitle=@{character_title} @{selected|token_name}}} {{Surprise=[[1d6cs0cf0+@{class_surprise_bonus}[class]-@{has_helm}[helm]+(@{mod_surprise}[mod1])+(?{Modifier|0}[mod2])]]}}' name='roll_surprise'> Surprise</button>
        <button type='roll' class='wideButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_reaction} **Reaction Roll**}} {{subtitle=@{character_title} @{selected|token_name}}} {{Roll=[[2d6cs0cf0+@{cha_mod}[cha]+(@{mod_reaction}[mod1])+(?{Modifier|0}[mod2])]]}} {{desc=2 or less: Hostile, attacks. 3-5: Unfriendly, may attack. 6-8: Neutral, uncertain. 9-11: Indifferent, uninterested. 12+: Friendly, helpful}}' name='roll_reaction'> Reaction</button>
        <button type='roll' class='wideButton' value='/w gm &{template:custom} {{title=@{banner_morale} **Morale Roll**}} {{subtitle=@{character_title} @{selected|token_name}}} {{Roll=[[2d6cs0cf0+(@{morale}[rating])+(?{Modifier|0}[mod])]]}} {{desc=2 or less: Frightened Retreat. 3-5: Morale Faltering. 6-8: Fight On. 9-11: Advance and Pursue. 12+: Victory or Death}}' name='roll_morale'> Morale</button>
        <input type='number' value='0' title='@{mod_initiative}' name='attr_mod_initiative'/>
        <input type='number' value='0' title='@{mod_surprise}' name='attr_mod_surprise'/>
        <input type='number' value='0' title='@{mod_reaction}' name='attr_mod_reaction'/>
        <input type='number' value='0' title='@{mod_morale}' name='attr_mod_morale'/>
    </div>
    <hr/>
    <div class='grid-armor'>
        <label>Armor <span title='The armor currently being worn.'>(?)</span></label>
        <label>Bonus</label>
        <label>Shield</label>
        <label>Helm <span title='Check only if heavy helm.'>(?)</span></label>         
        <label>Armor Class</label>
        <label>Fighting Style Specialization</label>
        <select title='@{armor}' name='attr_armor'>
            <option value='0' selected>AC 0 - Clothing Only</option>
            <option value='1'>AC 1 - Hide, Fur, or Padded</option>
            <option value='2'>AC 2 - Leather or Arena</option>
            <option value='3'>AC 3 - Ring or Scale</option>
            <option value='4'>AC 4 - Chain, Laminated, or Arena</option>
            <option value='5'>AC 5 - Banded or Lamellar</option>
            <option value='6'>AC 6 - Plate</option>
        </select>
        <input type='number' value='0' title='@{armor_bonus}' name='attr_armor_bonus'/>
        <input type='checkbox' value='1' title='@{has_shield}' name='attr_has_shield'/>
        <input type='checkbox' value='1' title='@{has_helm}' name='attr_has_helm'/>  
        <input type='number' value='0' title='@{armor_class}' name='attr_armor_class' readonly/>
        <select title='@{fss}' name='attr_fss'>
            <option value='0' selected>None</option>
            <option value='1'>Missile Weapon (+1 Atk)</option>
            <option value='2'>Single Weapon (+1 Init)</option>
            <option value='3'>Dual Weapons (+1 Atk)</option>
            <option value='4'>Two-Handed (+1 Dmg)</option>
            <option value='5'>Wpn & Shield (+1 AC)</option>
        </select>
        <input type='hidden' value='0' name='attr_fss_missile'/>
        <input type='hidden' value='0' name='attr_fss_single'/>
        <input type='hidden' value='1' name='attr_fss_dual'/>
        <input type='hidden' value='0' name='attr_fss_two'/>
        <input type='hidden' value='0' name='attr_fss_shield'/>
    </div>
    <input type='hidden' name='attr_fss_missile'/>
    <hr/>
    <div class='grid-attacks'>
        <label>Attack Throw:</label>
            <input type='number' min='-9' max='12' value='10' title='@{attack_throw}' name='attr_attack_throw'/>
        <label>Max Cleaves:</label>
            <input type='number' min='0' max='14' value='0' title='@{max_cleaves}' name='attr_max_cleaves'/>
        <label>Attack Routine: </label>
            <input type='text' value='1 (weapon)' title='@{num_attacks}' name='attr_num_attacks'/>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Melee Attacks <span title='@{repeating_melee}'>(?)</span></label>
        <fieldset class='repeating_melee'>
            <button type='roll' class='reviewButton' value='/w @{character_name} &{template:custom} {{color=brown}} {{title=**Review Melee Attack**}} {{Attack/Weapon=@{melee_name}}} {{Attack Bonus=@{melee_bonus}}} {{Damage=@{melee_damage}}} {{Is Dual Wield=@{melee_is_dual}}} {{Is Finesse=@{melee_is_finesse}}} {{Is Two-handed=@{melee_is_2h}}} {{is Equipped=@{melee_equip}}} {{effects=@{melee_effects}}}' name='roll_review_melee'> Review</button>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_melee} **Melee Attack Throw**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=red}} {{Attack/Weapon=@{melee_name}}} {{Target=[[@{attack_throw}+(?{Target AC|0}[target AC])]]}} {{Roll=[[1d20+@{melee_attk_attr}+@{melee_bonus}[wpn]+(@{melee_is_dual}[dual]*@{fss_dual}[fss])-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}} {{damage=[[{@{melee_damage}[wpn]+@{damage_attr}+(@{class_damage_bonus}[class])+(@{melee_is_2h}[2h]*@{fss_two}[fss])-@{fatigue}[fatigue], 0d1+1}k1]]}} {{effects=@{melee_effects}}}' name='roll_melee_attack'> Attack</button>
            <input type='checkbox' title='@{melee_equip}' name='attr_melee_equip'/>
            <input type='text' class='attackname' placeholder='Attack name...' title='@{melee_name}' name='attr_melee_name'/>
            <label>Dmg:</label>
            <input type='hidden' class='dmgcheck' name='attr_isBadDmgFormula'/>
            <input class='reddmg' type='text' title='@{melee_damage}' name='attr_melee_damage'/>
            <label>long</label>
            <input type='checkbox' title='@{melee_is_long}' name='attr_melee_is_long'/>
            <label>more...</label>
            <input type='checkbox' class='toggle-show'/><br/>
            <div class='details'>
                <button type='roll' class='rollButton' value='@{whispertoggle} &{template:menu} {{title=@{banner_meleedamage} **Melee Damage Roll**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=red}} {{Attack/Weapon=@{melee_name}}} {{damage=[[{@{melee_damage}[wpn]+@{damage_attr}+(@{class_damage_bonus}[class])+(@{melee_is_2h}[2h]*@{fss_two}[fss])-@{fatigue}[fatigue], 0d1+1}k1]]}}' name='roll_melee_damage'> Damage</button>
                <label>Attk Bonus:</label><input type='number' min='-10' max='10' value='0' title='@{melee_bonus}' name='attr_melee_bonus'/>
                <label>dual</label><input type='checkbox' value='1' title='@{melee_is_dual}' name='attr_melee_is_dual'/>
                <label>finesse</label><input type='hidden' value='@{str_mod}[str]' name='attr_melee_attk_attr'/><input type='checkbox' value='1' title='@{melee_is_finesse}' name='attr_melee_is_finesse'/>
                <label>2h</label><input type='checkbox' value='1' title='@{melee_is_2h}' name='attr_melee_is_2h'/>
                <textarea placeholder='Optional Effects description...' title='@{melee_effects}' name='attr_melee_effects'></textarea>
            </div>
        </fieldset>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Missile Attacks <span title='@{repeating_missile}'>(?)</span></label>
        <fieldset class='repeating_missile'>
            <button type='roll' class='reviewButton' value='/w @{character_name} &{template:custom} {{color=brown}} {{title=**Review Missile Attack**}} {{Attack/Weapon=@{missile_name}}} {{Attack Bonus=@{missile_bonus}}} {{Damage=@{missile_damage}}} {{Ranges=@{missile_range}}} {{Ammo=@{missile_ammo}}} {{Is Thrown=@{missile_is_thrown}}} {{is Equipped=@{missile_equip}}} {{effects=@{missile_effects}}}' name='roll_review_missile'> Review</button>
            <button type='action' class='missileButton' name='act_missile-attack'> Attack</button>
            <input type='checkbox' title='@{missile_equip}' name='attr_missile_equip'/>
            <input type='text' class='attackname' placeholder='Attack name...' title='@{missile_name}' name='attr_missile_name'/>
            <label>Dmg:</label>
            <input type='hidden' class='dmgcheck' name='attr_isBadDmgFormula'/>
            <input class='reddmg' type='text' title='@{missile_damage}' name='attr_missile_damage'/>
            <label>Rng:</label>
            <input class='missilerange' type='text' title='@{missile_range}' name='attr_missile_range'/>
            <label>Ammo:</label>
            <input class='smallWidth' type='number' title='@{missile_ammo}' name='attr_missile_ammo'/>
            <label>more...</label>
            <input type='checkbox' class='toggle-show'/><br/>
            <div class='details'>
                <button type='roll' class='rollButton' value='@{whispertoggle} &{template:menu} {{title=@{banner_missiledamage} **Missile Damage Roll**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=red}} {{Attack/Weapon=@{missile_name}}} {{damage=[[{@{missile_damage}[wpn]+(@{missile_is_thrown}*@{damage_attr})+@{class_damage_bonus_missile}[class]+@{fss_missile}[fss]-@{fatigue}[fatigue], 0d1+1}k1]]}}' name='roll_missile_damage'> Damage</button>
                <label>Attk Bonus:</label><input type='number' value='0' title='@{missile_bonus}' name='attr_missile_bonus'/>
                <label>thrown</label><input type='checkbox' value='1' title='@{missile_is_thrown}' name='attr_missile_is_thrown'/>
                <textarea placeholder='Optional Effects description...' title='@{missile_effects}' name='attr_missile_effects'></textarea>
            </div>
        </fieldset>
    </div>
    <hr/>
</section>

<section class='studious'>
    <div class='grid-spellslots'>
        <label class='span-header'>Studious Slots by Spell Level</label>
        <label></label><label>level 1</label><label>level 2</label><label>level 3</label><label>level 4</label><label>level 5</label><label>level 6</label><label>level 7</label><label>level 8</label><label>level 9</label><label></label>
        <label>Slots</label>
        <input type='number' min='0' max='6' value='0' title='@{studious_1_max}' name='attr_studious_1_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_2_max}' name='attr_studious_2_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_3_max}' name='attr_studious_3_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_4_max}' name='attr_studious_4_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_5_max}' name='attr_studious_5_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_6_max}' name='attr_studious_6_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_7_max}' name='attr_studious_7_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_8_max}' name='attr_studious_8_max' />
        <input type='number' min='0' max='6' value='0' title='@{studious_9_max}' name='attr_studious_9_max' />
        <span></span>
        <label>Current</label>
        <input type='number' min='0' max='6' value='0' title='@{studious_1}' name='attr_studious_1'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_2}' name='attr_studious_2'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_3}' name='attr_studious_3'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_4}' name='attr_studious_4'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_5}' name='attr_studious_5'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_6}' name='attr_studious_6'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_7}' name='attr_studious_7'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_8}' name='attr_studious_8'/>
        <input type='number' min='0' max='6' value='0' title='@{studious_9}' name='attr_studious_9'/>
        <button type='action' class='actionButton' name='act_reset_studious_spells'>Reset</button>
        <label>Caster Level</label>
        <input type='number' min='0' max='14' value='0' title='@{caster_level}' name='attr_caster_level'/>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Studious Spells / Invocations <span title='@{repeating_spellsstudious}'>(?)</span></label>
        <input class='toggle-show' type='checkbox' name='attr_showstudiousspelllist' checked/> show/hide
        <div class='details'>
            <fieldset class='repeating_spellsstudious'>
                <button type='roll' class='reviewButton' value='/w @{character_name} &{template:custom} {{color=blue}} {{title=**@{spell_name}**}} {{subtitle=Studious Spell}} {{Spell Level=@{spell_level}}} {{Type=@{spell_type}}} {{Range=@{spell_range}}} {{Duration=@{spell_duration}}} {{Prepared=@{spell_prepared}}} {{desc=@{spell_details}}}' name='roll_review_spell'> Review</button>
                <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{color=blue}} {{title=@{banner_studious} **Casting @{spell_name}**}} {{subtitle=@{character_title} @{selected|token_name}}} {{Spell Level=@{spell_level}}} {{Type=@{spell_type}}} {{Range=@{spell_range}}} {{Duration=@{spell_duration}}} {{Caster Level=@{caster_level}}} {{Cast Confirmed=?{Confirm Action|Yes}}} {{desc=@{spell_details}}}' name='roll_cast_spell'> Cast</button>
                <input type='text' placeholder='Spell name...' title='@{spell_name}' name='attr_spell_name'/>
                <label>Spell Level:</label><input class='spellLevel' type='number' min='1' max='9' value='1' title='@{spell_level}' name='attr_spell_level'/>
                <label>prepared</label><input type='checkbox' value='Yes' title='@{spell_prepared}' name='attr_spell_prepared'/>
                <label>more...</label>
                <input type='checkbox' class='toggle-show'/><br/>
                <div class='details'>
                    <label>Type:</label><input type='text' title='@{spell_type}' name='attr_spell_type'/>
                    <label>Range:</label><input class='spellRange' type='text' title='@{spell_range}' name='attr_spell_range'/>
                    <label>Duration:</label><input class='spellDuration' type='text' title='@{spell_duration}' name='attr_spell_duration'/>
                    <textarea placeholder='Spell description...' title='@{spell_details}' name='attr_spell_details'></textarea>
                </div>
            </fieldset>
        </div>
    </div>
    <hr/>
</section>

<section class='prayerful'>
    <div class='grid-spellslots'>
        <label class='span-header'>Prayerful Slots by Spell Level</label>
        <label></label><label>level 1</label><label>level 2</label><label>level 3</label><label>level 4</label><label>level 5</label><label>level 6</label><label>level 7</label><label>level 8</label><label>level 9</label><label></label>
        <label>Slots</label>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_1_max}' name='attr_prayerful_1_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_2_max}' name='attr_prayerful_2_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_3_max}' name='attr_prayerful_3_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_4_max}' name='attr_prayerful_4_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_5_max}' name='attr_prayerful_5_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_6_max}' name='attr_prayerful_6_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_7_max}' name='attr_prayerful_7_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_8_max}' name='attr_prayerful_8_max' />
        <input type='number' min='0' max='6' value='0' title='@{prayerful_9_max}' name='attr_prayerful_9_max' />
        <span></span>
        <label>Current</label>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_1}' name='attr_prayerful_1'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_2}' name='attr_prayerful_2'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_3}' name='attr_prayerful_3'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_4}' name='attr_prayerful_4'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_5}' name='attr_prayerful_5'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_6}' name='attr_prayerful_6'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_7}' name='attr_prayerful_7'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_8}' name='attr_prayerful_8'/>
        <input type='number' min='0' max='6' value='0' title='@{prayerful_9}' name='attr_prayerful_9'/>
        <button type='action' class='actionButton' name='act_reset_prayerful'>Reset</button>
        <label>Caster Level</label>
        <input type='number' min='0' max='14' value='0' title='@{caster_level}' name='attr_caster_level'/>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Prayerful Spells / Invocations <span title='@{repeating_spellsprayerful}'>(?)</span></label>
        <input class='toggle-show' type='checkbox' name='attr_showprayerfulspelllist' checked/> show/hide
        <div class='details'>
            <fieldset class='repeating_spellsprayerful'>
                <button type='roll' class='reviewButton' value='/w @{character_name} &{template:custom} {{color=gold}} {{title=**@{spell_name}**}} {{subtitle=Prayerful Spell}} {{Spell Level=@{spell_level}}} {{Type=@{spell_type}}} {{Range=@{spell_range}}} {{Duration=@{spell_duration}}} {{desc=@{spell_details}}}' name='roll_review_spell'> Review</button>
                <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{color=gold}} {{title=@{banner_prayerful} **Casting @{spell_name}**}} {{subtitle=@{character_title} @{selected|token_name}}} {{Spell Level=@{spell_level}}} {{Type=@{spell_type}}} {{Range=@{spell_range}}} {{Duration=@{spell_duration}}} {{Caster Level=@{caster_level}}} {{Cast Confirmed=?{Confirm Action|Yes}}} {{desc=@{spell_details}}}' name='roll_cast_spell'> Cast</button>
                <input type='text' placeholder='Spell name...' title='@{spell_name}' name='attr_spell_name'/>
                <label>Level:</label><input class='spellLevel' type='number' min='1' max='9' value='1' title='@{spell_level}' name='attr_spell_level'/>
                <label>more...</label>
                <input type='checkbox' class='toggle-show'/><br/>
                <div class='details'>
                    <label>Type:</label><input type='text' title='@{spell_type}' name='attr_spell_type'/>
                    <label>Range:</label><input class='spellRange' type='text' title='@{spell_range}' name='attr_spell_range'/>
                    <label>Duration:</label><input class='spellDuration' type='text' title='@{spell_duration}' name='attr_spell_duration'/>
                    <textarea placeholder='Spell description...' title='@{spell_details}' name='attr_spell_details'></textarea>
                </div>
            </fieldset>
        </div>
    </div>
    <hr/>
</section>

<section class='skills'>
    <div>
        <label class='span-header'>Proficiencies <span title='@{repeating_skills}'>(?)</span></label>
        <fieldset class='repeating_skills'>
            <button type='roll' class='reviewButton' value='/w @{character_name} &{template:custom} {{color=brown}} {{title=**Review @{skill_name}**}} {{Rank=@{skill_rank}}} {{Type=@{skill_type}}} {{desc=@{skill_details}}}' name='roll_review_skill'> Review</button>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_profthrow} **Proficiency Throw**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=brown}} {{Using=@{skill_name}}} {{Target=[[@{skill_target}-((@{skill_rank}-1)*4)[rank]]]}} {{Roll=[[1d20[die]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_skill_check'> Throw</button>
            <input type='text' placeholder='Proficiency name...' title='@{skill_name}' name='attr_skill_name'/>
            <label>Rank:</label><input type='number' min='0' max='4' value='1' title='@{skill_rank}' name='attr_skill_rank'/>
            <label>Type:</label>
                <select class='shorter' title='@{skill_type}' name='attr_skill_type'>
                    <option>Bonus</option>
                    <option>Class</option>
                    <option>Class Power</option>
                    <option selected>General</option>
                </select>
            <label>more...</label>
                <input type='checkbox' class='toggle-show'/><br/>
                <div class='details'>
                    <label class='detailslabel'>Target:</label>
                    <input class='skillScript' type='text' title='@{skill_target}' name='attr_skill_target'/><br/>
                    <textarea placeholder='Optional description...' title='@{skill_details}' name='attr_skill_details'></textarea>
                </div>
        </fieldset>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Abilities <span title='@{repeating_abilities}'>(?)</span></label>
        <fieldset class='repeating_abilities'>
            <button type='roll' class='reviewButton' value='/w @{character_name} &{template:custom} {{color=brown}} {{title=**Review @{ability_name}**}} {{Source=@{ability_source}}} {{desc=@{ability_details}}}' name='roll_review_ability'> Review</button>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_abilitythrow} **Ability Throw**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=brown}} {{Using=@{ability_name}}} {{Target=[[@{ability_target}]]}} {{Roll=[[1d20[die]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_ability_check'> Throw</button>
            <input type='text' placeholder='Skill name...' title='@{ability_name}' name='attr_ability_name'/>
            <label>Source: </label><input type='text' title='@{ability_source}' name='attr_ability_source'/>
            <label>more...</label>
            <input type='checkbox' class='toggle-show'/><br/>
            <div class='details'>
                <label class='detailslabel'>Target:</label><input class='skillScript' type='text' title='@{ability_target}' name='attr_ability_target'/><br/>
                <textarea placeholder='Optional description...' title='@{ability_details}' name='attr_ability_details'></textarea>
            </div>
        </fieldset>
    </div>
    <hr/>
</section>

<section class='equipment'>
    <div class='grid-encumbrance'>
        <label>Capacity, Max</label> <input type='number' value='20' title='@{enc_capacity}' name='attr_enc_capacity' readonly/>
        <label>Encumbrance</label> 
        <input type='hidden' class='encOverFive' name='attr_enc_over_five'/>
        <input class='orangeEnc' type='number' value='0' title='@{encumbrance}' name='attr_encumbrance' readonly />
        <label>Feet / Turn</label> 
            <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
            <input class='redmove' type='number' value='120' title='@{move_turn}' name='attr_move_turn' readonly/> 
        <label>Feet / Round</label> 
            <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
            <input class='redmove' type='number' value='40' title='@{move_round}' name='attr_move_round' readonly/>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Equipment <span title='@{repeating_items}'>(?)</span></label>
        <input class='toggle-show' type='checkbox' name='attr_show_equipment' checked/> show/hide
        <div class='details'>
            <fieldset class='repeating_items'>
                <input type='text' placeholder='Item name...' title='@{item_name}' name='attr_item_name'/>
                <label>#</label><input class='itemCount' type='number' min='0' value='1' title='@{item_count}' name='attr_item_count'/>
                <label>stone</label><input class='itemWeight' type='number' min='0' value='0.16' step='.01' title='@{item_weight}' name='attr_item_weight'/>
                <label>value</label><input class='itemValue' type='number' min='0' title='@{item_value}' name='attr_item_value'/>
                <label>equipped</label><input type='checkbox' value='1' title='@{item_equipped}' name='attr_item_equipped' checked />
                <label>more...</label><input type='checkbox' class='toggle-show'/><br/>
                <div class='details'><textarea placeholder='Optional description...' title='@{item_details}' name='attr_item_details'></textarea></div>
            </fieldset>
            <input type='hidden' value='0' name='attr_items_weight'/>
        </div>
    </div>
    <hr/>
</section>

<section class='wealth'>
    <div class='grid-2column'>
        <div class='grid-currency'>
            <input type='hidden' value='0' name='attr_currency_weight'/>
            <label class='span-header'>Currency</label>
            <label></label><label>On Hand</label><label>Banked</label><label>New <span title='Use this to add/remove coins from On Hand column.'>(?)</span></label>  
            <label>PP <span title='=5gp'>(?)</span></label>
                <input class='currency' type='number' value='0' min='0' title='@{platinum}' name='attr_platinum'/>
                <input class='currency' type='number' value='0' min='0' title='@{platinum_bank}' name='attr_platinum_bank'/>
                <input class='currency' type='number' value='0' title='@{platinum_found}' name='attr_platinum_found'/>
            <label>GP <span title='=1gp'>(?)</span></label>
                <input class='currency' type='number' value='0' min='0' title='@{gold}' name='attr_gold'/>
                <input class='currency' type='number' value='0' min='0' title='@{gold_bank}' name='attr_gold_bank'/>
                <input class='currency' type='number' value='0' title='@{gold_found}' name='attr_gold_found'/>
            <label>EP <span title='=1/2gp'>(?)</span></label>
                <input class='currency' type='number' value='0' min='0' title='@{electrum}' name='attr_electrum'/>
                <input class='currency' type='number' value='0' min='0' title='@{electrum_bank}' name='attr_electrum_bank'/>
                <input class='currency' type='number' value='0' title='@{electrum_found}' name='attr_electrum_found'/>
            <label>SP <span title='=1/10gp'>(?)</span></label>
                <input class='currency' type='number' value='0' min='0' title='@{silver}' name='attr_silver'/>
                <input class='currency' type='number' value='0' min='0' title='@{silver_bank}' name='attr_silver_bank'/>
                <input class='currency' type='number' value='0' title='@{silver_found}' name='attr_silver_found'/>
            <label>CP <span title='=1/100gp'>(?)</span></label>
                <input class='currency' type='number' value='0' min='0' title='@{copper}' name='attr_copper'/>
                <input class='currency' type='number' value='0' min='0' title='@{copper_bank}' name='attr_copper_bank'/>
                <input class='currency' type='number' value='0' title='@{copper_found}' name='attr_copper_found'/>
            <label></label><label>capacity</label><label>wealth</label>
            <button class='actionButton' type='action' title='Click to move coins from New to On Hand.' name='act_claim_currency'>Claim</button>
            <span></span>
            <input class='currency' type='number' value='0' title='@{currency_capacity}' name='attr_currency_capacity' readonly/>
            <input class='currency' type='number' value='0' title='@{currency_wealth}' name='attr_currency_wealth' readonly/>
            <span></span>
        </div>
        <div class='grid-2column'>
            <label class='span-header'>Monthly Budget</label>
            <label>Living Standard (Level)</label>
                <select title='@{living_standard}' name='attr_living_standard'>
                    <option value='1'>Wretched</option>
                    <option value='3'>Meager</option>
                    <option value='12' selected>Adequate (1)</option>
                    <option value='40'>Comfortable (2)</option>
                    <option value='100'>Prosperous (3-4)</option>
                    <option value='450'>Affluent (5-7)</option>
                    <option value='2000'>Sumptuous (8-9)</option>
                    <option value='12000'>Luxuriant (10-12)</option>
                    <option value='80000'>Lavishly Opulent (13-14)</option>
                </select>
            <label>Hireling Wages</label>
                <div><input class='currency' type='number' value='0' title='@{hireling_fees}' name='attr_hireling_fees' readonly/> gp</div>
            <label>Professional Income</label>
                <div><input type='number' value='0' title='@{professional_income}' name='attr_professional_income'/> gp</div>
            <hr class='spangrid'/>
            <label class='emphasis'>Monthly Balance</label>
                <div><input type='number' value='-12' title='@{monthly_balance}' name='attr_monthly_balance' readonly/> gp</div>
        </div>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Passive Investments <span title='@{repeating_investments}'>(?)</span></label>
        <input class='toggle-show' type='checkbox' name='attr_show_investments' checked/> show/hide
        <div class='details'>
            <fieldset class='repeating_investments'>
                <label>Amount</label><input class='currency' type='number' min='0' title='@{investment_amount}' name='attr_investment_amount'/>
                <label>Type</label>
                    <select class='shorter' title='@{investment_type}' name='attr_investment_type'>
                        <option value='1'>Buisiness Establishment</option>
                        <option value='2'>Commercial Investment</option>
                        <option value='3'>Money Lending</option>
                    </select>
                <label>Level of Risk</label>
                    <select class='shorter' title='@{investment_risk}' name='attr_investment_risk'>
                        <option value='1'>Safe (0.25% / mo.)</option>
                        <option value='2'>Cautious (0.5% / mo.)</option>
                        <option value='3'>Balanced (1% / mo.)</option>
                        <option value='4'>Risky (3% / mo.)</option>
                        <option value='5'>Perilous (9% / mo.)</option>
                    </select>
                <label>more...</label><input type='checkbox' class='toggle-show'/><br/>
                <div class='details'><textarea placeholder='Investment details...' title='@{investment_details}' name='attr_investment_details'></textarea></div>
            </fieldset>
        </div>
    </div>
    <hr/>
</section>

<section class='hirelings'>
    <div class='grid-2column'>
        <div class='grid-hirelings'>
            <label>Henchmen Limit:</label> 
                <input type='hidden' class='henchmenCheck' name='attr_henchmen_count'/>
                <input class='limitExceeded' type='number' value='4' title='@{henchmen_limit}' name='attr_henchmen_limit' readonly/> 
            <label></label><label></label>
        </div>
        <div class='grid-hirelings'>
            <label>Hireling Wages:</label><input class='currency' type='number' value='0' title='@{hireling_fees}' name='attr_hireling_fees' readonly/>
            <label></label><label></label>
        </div>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Henchmen <span title='@{repeating_henchmen}'>(?)</span></label>
        <fieldset class='repeating_henchmen'>
            <input class='hirelingName' type='text' placeholder='Name...' title='@{henchman_name}' name='attr_henchman_name'/>
            <label class='detailslabel'>Loyalty:</label>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_henchmen} **Loyalty Roll**}} {{subtitle=@{henchman_name}}} {{color=black}} {{Roll=[[2d6cs0cf0+(@{henchman_loyalty}[loyalty])+(@{cha_mod}[CHA])+(@{class_hireling_loyalty_bonus}[class])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Hostility&#13;3-5: Resignation&#13;6-8: Gruding Loyalty&#13;9-11: Loyalty&#13;12+: Fanatic Loyalty}}' name='roll_henchman_loyalty_check' ></button>
                <input type='number' min='-4' max='4' value='0' title='@{henchman_loyalty}' name='attr_henchman_loyalty'/>
            <label class='detailslabel'>Morale:</label>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_henchmen} **Morale Roll**}} {{subtitle=@{henchman_name}}} {{color=black}} {{Roll=[[2d6cs0cf0+(@{henchman_morale}[morale])+(@{class_henchmen_morale_bonus}[class])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Refuses&#13;3-5: Begrudging&#13;6+: Compliant}}' name='roll_henchman_obedience_check' ></button>
                <input type='number' min='-4' max='4' value='0' title='@{henchman_morale}' name='attr_henchman_morale'/>
            <label>Wage (gp):</label>
            <input class='currency' type='number' value='12' title='@{henchman_fee}' name='attr_henchman_fee' readonly/>
            <label>more...</label>
            <input type='checkbox' class='toggle-show' /><br/>
            <div class='details'>
                <label>Class:</label>
                    <input type='text' class='henchClass' title='@{henchman_class}' name='attr_henchman_class'/>
                <label>Level:</label>
                    <input type='number' min='0' max='14' value='0' title='@{henchman_level}' name='attr_henchman_level'/>
                <textarea placeholder='Enter notes here...' title='@{henchman_details}' name='attr_henchman_details'></textarea>
            </div>
        </fieldset>
        <input type='hidden' name='attr_henchmen_fees'/>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Mercenaries <span title='@{repeating_mercenaries}'>(?)</span></label>
        <fieldset class='repeating_mercenaries'>
            <input class='hirelingName' type='text' placeholder='Name...' title='@{merc_name}' name='attr_merc_name'/>
            <label class='detailslabel'>Loyalty:</label>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_mercenary} **Loyalty Roll**}} {{subtitle=@{merc_name}}} {{color=black}} {{Roll=[[2d6cs0cf0+(@{merc_loyalty}[loyalty])+(@{cha_mod}[CHA])+(@{class_hireling_loyalty_bonus}[class])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Hostility&#13;3-5: Resignation&#13;6-8: Gruding Loyalty&#13;9-11: Loyalty&#13;12+: Fanatic Loyalty}}' name='roll_merc_loyalty_check' ></button>
                <input type='number' min='-4' max='4' value='0' title='@{merc_loyalty}' name='attr_merc_loyalty'/>
            <label class='detailslabel'>Morale:</label>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_mercenary} **Morale Roll**}} {{subtitle=@{merc_name}}} {{color=black}} {{Roll=[[2d6cs0cf0+(@{merc_morale}[morale])+(@{class_henchmen_morale_bonus}[class])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Refuses&#13;3-5: Begrudging&#13;6+: Compliant}}' name='roll_merc_obedience_check' ></button>
                <input type='number' min='-4' max='4' value='0' title='@{merc_morale}' name='attr_merc_morale'/>
            <label>Wage (gp):</label>
            <input class='currency' type='number' title='@{merc_fees}' name='attr_merc_fees' readonly/>
                <label>more...</label>
            <input type='checkbox' class='toggle-show' /><br/>
            <div class='details'>
                <label>Type:</label>
                    <input class='mercType' type='text' title='@{merc_type}' name='attr_merc_type'/>
                <label>Race:</label>
                    <input class='mercRace' type='text' title='@{merc_race}' name='attr_merc_race'/>
                <label>Set Wage (gp, per troop):</label>
                <input class='currency' type='number' value='0' title='@{merc_fee}' name='attr_merc_fee'/>
                <label>Quantity:</label>
                     <input type='number' min='0' value='0' title='@{merc_number}' name='attr_merc_number'/>
                <textarea placeholder='Enter notes here...' title='@{merc_details}' name='attr_merc_details'></textarea>
            </div>
        </fieldset>
        <input type='hidden' name='attr_mercenary_fees'/>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Specialists <span title='@{repeating_specialists}'>(?)</span></label>
        <fieldset class='repeating_specialists'>
            <input class='hirelingName' type='text' placeholder='Name...' title='@{spec_name}' name='attr_spec_name'/>
            <label class='detailslabel'>Loyalty:</label>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_specialist} **Loyalty Roll**}} {{subtitle=@{spec_name}}} {{color=black}} {{Roll=[[2d6cs0cf0+(@{spec_loyalty}[loyalty])+(@{cha_mod}[CHA])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Hostility&#13;3-5: Resignation&#13;6-8: Gruding Loyalty&#13;9-11: Loyalty&#13;12+: Fanatic Loyalty}}' name='roll_spec_loyalty_check' ></button>
                <input type='number' min='-4' max='4' value='0' title='@{spec_loyalty}' name='attr_spec_loyalty'/>
            <label class='detailslabel'>Morale:</label>
            <button type='roll' class='rollButton' value='@{whispertoggle} &{template:custom} {{title=@{banner_specialist} **Morale Roll**}} {{subtitle=@{spec_name}}} {{color=black}} {{Roll=[[2d6cs0cf0+(@{spec_morale}[morale])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Refuses&#13;3-5: Begrudging&#13;6+: Compliant}}' name='roll_spec_obedience_check' ></button>
                <input type='number' min='-4' max='4' value='0' title='@{spec_morale}' name='attr_spec_morale'/>
            <label>Wage (gp):</label>
            <input class='currency' type='number' value='0' title='@{spec_fee}' name='attr_spec_fee' readonly/>
                <label>more...</label>
            <input type='checkbox' class='toggle-show' /><br/>
            <div class='details'>
                <label>Type:</label>
                    <input type='text' class='specType' title='@{spec_occupation}' name='attr_spec_occupation'/>
                <label>Set Wage (gp):</label>
                    <input class='currency' type='number' value='0' title='@{spec_fee}' name='attr_spec_fee'/>
                <textarea placeholder='Enter notes here...' title='@{spec_details}' name='attr_spec_details'></textarea>
            </div>
        </fieldset>
        <input type='hidden' name='attr_specialist_fees'/>
    </div>
    <hr/>
</section>

<section class='journal'>
    <div>
        <label class='span-header'>Character Background</label>
        <textarea class='background' placeholder='Enter details...' title='@{background}' name='attr_background'></textarea>
    </div>
    <div class='grid-journal'>
        <div class='journalbox'>
            <label class='span-header'>Appearance</label>
            <textarea class='journalnotes' placeholder='Enter details...' title='@{appearance}' name='attr_appearance'></textarea>
        </div>
        <div class='journalbox'>
            <label class='span-header'>Languages</label>
            <textarea class='journalnotes' placeholder='Enter details...' title='@{languages}' name='attr_languages'>Common</textarea>
        </div>
        <div class='journalbox'>
            <label class='span-header'>Injuries</label>
            <textarea class='journalnotes' placeholder='Enter details...' title='@{injuries}' name='attr_injuries'></textarea>
        </div>
        <div class='journalbox'>
            <label class='span-header'>Property & Debts</label>
            <textarea class='journalnotes' placeholder='Enter details...' title='@{property}' name='attr_property'></textarea>
        </div>
    </div>
    <div>
        <label class='span-header'>Adventuring Notes <span title='@{repeating_journal}'>(?)</span></label>
        <fieldset class='repeating_journal'>
            <label>Title: </label><input type='text' title='@{journal_title}' name='attr_journal_title'/>
            <label>more... </label><input type='checkbox' class='toggle-show' />
            <div class='details'><textarea placeholder='Enter details...' title='@{journal_details}' name='attr_journal_details'></textarea></div>
        </fieldset>
    </div>
    <hr/>
    <div>
        <label class='span-header'>Experience Log <span title='@{repeating_experience}'>(?)</span></label>
        <fieldset class='repeating_experience'>            
            <label>Date: </label><input class='xpdate' type='text' title='@{xp_date}' name='attr_xp_date'/>
            <label>XP: </label><input class='xpamount' type='number' title='@{xp_amount}' name='attr_xp_amount'/>
            <label>Bonus %: </label><input class='xpamount' type='number' title='@{xp_bonus}' name='attr_xp_bonus'/>
            <label>Note: </label><input class='xpdescription' type='text' title='@{xp_description}' name='attr_xp_description'/>
        </fieldset>
    </div>
    <hr/>
</section>

<section class='settings'>
    <div class='grid-settings'>
        <label class='span-header'>Sheet Settings</label>
        <label>Save Attributes</label>
            <button type='action' class='actionButton' name='act_save_attrs'>Update</button>
            <span>Copy the character's attribute values into the Overview tab's Nominal column.</span>
        <label>Experience % Modifier</label>
            <input type='number' value='0' title='@{xp_modifier}' name='attr_xp_modifier'/>            
            <span>Modify the character's XP modifier from key attributes.</span>
        <label>Damage Attribute</label>
            <input type='hidden' value='@{str_mod}[str]' name='attr_damage_attr'/>
            <select class='settingsSelect' title='@{select_damage_attr}' name='attr_select_damage_attr'>
                <option selected>str</option>
                <option>int</option>
                <option>wil</option>
                <option>dex</option>
                <option>con</option>
                <option>cha</option>
            </select>
            <span>Set the attribute modifier used to modify melee/thrown damage rolls.</span>
        <label>Roll Attributes</label>
            <div>
                <button type='action' class='actionButton' name='act_roll_PC'>PC</button>
                <button type='action' class='actionButton' name='act_roll_0th'>0th</button>
            </div>
            <span>Replaces the character's current attributes with a new, randomly rolled set.</span>
        <hr class='spangrid'/>
        <label>Hide Studious Tab</label>
            <input type='checkbox' value='1' title='@{toggle_studious}' name='attr_toggle_studious'/>
            <span>Hide the Studious tab on the character sheet.</span>
        <label>Hide Prayerful Tab</label>
            <input type='checkbox' value='1' title='@{toggle_prayerful}' name='attr_toggle_prayerful'/>
            <span>Hide the Prayerful tab on the character sheet.</span>
        <label>Hide Code of Behavior</label>
            <input type='checkbox' value='1' title='@{toggle_behavior}' name='attr_toggle_behavior'/>
            <span>Hide the Code of Behavior section on the Class tab.</span>
        <label>Enc Alert</label>
            <input type='checkbox' value='1' title='@{enc_alert_toggle}' name='attr_enc_alert_toggle'/>
            <span>Highlight the encumbrance field if/when the value exceeds the Encumbrance Alert Threshold.</span>
        <label>End Alert Threshold</label>
            <input type='number' min='0' value='5' title='@{move_alertThresh}' name='attr_move_alertThresh'/>
            <span>The Encumbrance Alert threshold.</span>
        <hr class='spangrid'/>
        <label>Enc Threshold 1</label>
            <input type='number' min='0' value='5' title='@{move_thresh1}' name='attr_move_thresh1'/>
            <span>Set the character's first encumbrance threshold.</span>
        <label>Enc Threshold 2</label>
            <input type='number' min='0' value='7' title='@{move_thresh2}' name='attr_move_thresh2'/>
            <span>Set the character's second encumbrance threshold.</span>
        <label>Enc Threshold 3</label>
            <input type='number' min='0' value='10' title='@{move_thresh3}' name='attr_move_thresh3'/>
            <span>Set the character's third encumbrance threshold.</span>
        <label>Max Encumbrance</label>
            <input type='number' min='0' value='20' title='@{base_enc}' name='attr_base_enc'/>
            <span>Set the character's maximum encumbrance threshold.</span>
        <label>Max Movement</label>
            <input type='number' min='0' value='120' title='@{base_movement}' name='attr_base_movement'/>
            <span>Set the character's maximum base land movement speed.</span>
        <hr class='spangrid'/>
        <label>Tension Pool</label>
            <div>
                <button type='action' class='actionButton' name='act_add_tension'>+hp</button>
                <button type='action' class='actionButton' name='act_clear_tension'>clr</button>
            </div>
            <span>Used to increase and clear hp when char used as tension/time pool.</span>
    </div>
    <hr/>
</section>

<div>
    <p>Designed for use with the Adventurer Conqueror King System, Imperial Imprint and published under the ACKS SRD/OGL, https://github.com/capheind/ACKS_SRD.</p>
</div>

<!-- Banner placeholders (see readme) -->
<input type='hidden' name='attr_banner_abilitythrow' value='[x](https://files.d20.io/images/163997102/AXOfRJppTnocIWR5Y_lPcA/original.png?15999344525#.png)'/>
<input type='hidden' name='attr_banner_hd' value='[x](https://files.d20.io/images/164485275/i57K47MV1THHsgVdkZxVXg/original.png?16001099615#.png)'/>
<input type='hidden' name='attr_banner_henchmen' value='[x](https://s3.amazonaws.com/files.d20.io/images/164482040/OH6hqtvCHGeesUaO0b37vQ/original.png?16001087875#.png)'/>
<input type='hidden' name='attr_banner_init' value='[x](https://files.d20.io/images/240216164/eJ_5t2QOceZDGACZmtb9Mw/original.png?16291501135#.png)'/>
<input type='hidden' name='attr_banner_knowledge' value='[x](https://files.d20.io/images/164632524/aBwd4RZHlhj38rJDw7gocg/original.png?160018233953.png)'/>
<input type='hidden' name='attr_banner_melee' value='[x](https://files.d20.io/images/208788284/v3Vh7I66OLF3eKErbCtE8g/original.png?16159365185#.png)'/>
<input type='hidden' name='attr_banner_meleedamage' value='[x](https://files.d20.io/images/164319112/w9iRcBuEc3vZcFvB41B2cA/original.png?16000311685#.png)'/>
<input type='hidden' name='attr_banner_mercenary' value='[x](https://files.d20.io/images/164502952/QDUm2hoU_8YnEidHpdt3gA/original.png?16001161945#.png)'/>
<input type='hidden' name='attr_banner_missile' value='[x](https://files.d20.io/images/208379586/aJ7XMROQPw9EdHe_cTeuwA/original.png?16157644605#.png)'/>
<input type='hidden' name='attr_banner_missiledamage' value='[x](https://files.d20.io/images/286766649/SQOMglW-zJ64W6pF2WwoHA/original.png?16535055965#.png)'/>
<input type='hidden' name='attr_banner_morale' value='[x](https://files.d20.io/images/208789845/qBZORlDrO_zhnHZSf1TJew/original.png?16159368735#.png)'/>
<input type='hidden' name='attr_banner_prayerful' value='[x](https://files.d20.io/images/164804063/D-59VtVXmMI0BoQcEImVLQ/original.png?16002611425#.png)'/>
<input type='hidden' name='attr_banner_profthrow' value='[x](https://files.d20.io/images/207932677/LevG9TaeM8A0iSvU1oJ2AA/original.png?16156570495#.png)'/>
<input type='hidden' name='attr_banner_reaction' value='[x](https://files.d20.io/images/164051897/DDBz__NPDHQATVmlK4-fkw/original.png?15999466705#.png)'/>
<input type='hidden' name='attr_banner_saveblast' value='[x](https://files.d20.io/images/164351057/V_5Pg1KGLIFLY3hfmQnIAQ/original.png?16000385285#.png)'/>
<input type='hidden' name='attr_banner_savedeath' value='[x](https://files.d20.io/images/164431733/S44njdUWMNsVpYVQ8O3TiA/original.png?16000843735#.png)'/>
<input type='hidden' name='attr_banner_saveimplements' value='[x](https://files.d20.io/images/164443445/Bc7tBY3rr7Gfs80GrtIRxg/original.png?16000924335#.png)'/>
<input type='hidden' name='attr_banner_saveparalysis' value='[x](https://files.d20.io/images/164446142/pUtaLtutH011f9ZjtaQgrg/original.png?16000939805#.png)'/>
<input type='hidden' name='attr_banner_savespells' value='[x](https://files.d20.io/images/164818577/jtP4uMJplv3U1PGD7TstAQ/original.png?16002676365#.png)'/>
<input type='hidden' name='attr_banner_specialist' value='[x](https://files.d20.io/images/207056809/Ign3w6DKvLOyRsZ8mP7eWw/original.png?16153387165#.png)'/>
<input type='hidden' name='attr_banner_studious' value='[x](https://files.d20.io/images/366620236/19tKcTGuUOIhPSfsT7bAPw/original.png?16993181055#.png)'/>
<input type='hidden' name='attr_banner_surprise' value='[x](https://files.d20.io/images/207158604/34Vzrkx7J2nxNs9STGOuzg/original.png?16153942615#.png)'/>

<script type='text/worker'>
/**************************************************
** Global Constants
***************************************************/
const ATTR_SCORE_DEFAULT = 10;
const ATTR_MELEE_MOD_DEFAULT = '@{str_mod}[str]';
const ATTR_MELEE_MOD_FINESSE = '@{dex_mod}[dex]';
const COIN_WEIGHT = 0.001;
const CURRENT_VERSION = 2;
const DIE_DELIMITER = 'd';
const EMPTY_STRING = '';
const HENCHMEN_LIMIT = 4;
const INIT_HP = 1;
const INIT_MOVE_ROUND = 40;
const INIT_AC = 0;
const SAVE_MIN_TARGET = 1;
const XP_BONUS_MAX = 10;

/**************************************************
** On Sheet Initialization / Opening
***************************************************/
on('sheet:opened',function(){
    getAttrs(['sheet_version', 'hit_dice'], function(values) {
        const sheetVersion = parseInt(values.sheet_version) || 0;
        const hitDice = values.hit_dice;
        
        const output = {};

        // Force creation of sheet attributes that can be bound to 
        // immediately by token bars (w/o having to change attributes manually).
        // On first load only.
        if (sheetVersion < 1)
        {
            output['hp'] = output['hp_max'] = INIT_HP;
            output['move_round'] = INIT_MOVE_ROUND;
            output['armor_class'] = INIT_AC;
        }

        // Initialize the hit dice field (to ensure flagging on a new sheet)
        output['isBadHDFormula'] = (hitDice == EMPTY_STRING) ? 1 : 0;

        // Set upgrade version to latest
        output['sheet_version'] = CURRENT_VERSION;

        setAttrs(output);
    });
});

/**************************************************
** Sheet Helper Functions
***************************************************/
// global helper to retrieve repeating section item ids
function getID(repeatingItemName) {
    const idStartPosition = repeatingItemName.indexOf('_',10) + 1;
    const idEndPosition = repeatingItemName.indexOf('_',idStartPosition+1);
    const theID = repeatingItemName.substring(idStartPosition, idEndPosition);
    return theID;
};

// Randomly shuffles the contents of an array
// Note that the original array is shuffled as well.
function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// Roll dice
function rollDice(numDice, numSides, numDrop) {
    const theDice = parseInt(numDice) || 1; // assume 1 die
    const theSides = parseInt(numSides) || 6; // assume a d6
    const theDrop = parseInt(numDrop) || 0; // assume drop none

    const results = [];
    for (var i = 0; i < theDice; i++) { results.push(Math.floor(Math.random() * theSides + 1)); }
    results.sort(compareNumbers);
    for (var i = 0; i < theDrop; i++) { results.pop(); }
    let result = 0;
    for (var i = 0; i < results.length; i++) { result += results[i]; }

    return result;

    function compareNumbers(a, b) {
        return b - a;
    }
}

// Validates a dice formula.
// If validation fails, return an empty string.
// A valid dice formula is [num]d[num][+/1][num].
// E.G. 2d6, 1d4-1, 9d8+2, 40d3, etc.
function validateDieFormula(theDieFormula) {
    const theDelimiter = theDieFormula.toLowerCase().indexOf(DIE_DELIMITER);
    if (theDelimiter == -1) return EMPTY_STRING; // bad string    
    const numberOfHitDice = theDieFormula.slice(0,theDelimiter);
    if (isNaN(numberOfHitDice)) return EMPTY_STRING; // bad string
    const restOfString = theDieFormula.slice(theDelimiter + 1);
    const theOperator = restOfString.indexOf('+') > -1 ? restOfString.indexOf('+') : restOfString.indexOf('-') > -1 ? restOfString.indexOf('-') : -1;
    const numSides = theOperator != -1 ? restOfString.slice(0,theOperator) : restOfString;
    if (isNaN(numSides)) return EMPTY_STRING; // bad string
    const modValue = theOperator != -1 ? restOfString.slice(theOperator + 1) : 0;
    if (isNaN(modValue)) return EMPTY_STRING; // bad string  
    
    // All tests passed
    return theDieFormula;
};

/**************************************************
** Tab Controls / Header
***************************************************/
// Select/deselect buttons
const buttonlist = ['overview','class','studious','prayerful', 'skills','combat','equipment','wealth','hirelings','journal','settings'];
buttonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetButtons: button,
            sheetTab: button
        });
    });
});

// Show/hide the Studious tab
on('change:toggle_studious', function(eventInfo) {

    const output = {};
    output['show_studious'] = eventInfo.newValue;
    setAttrs(output);
});

// Show/hide the Prayerful tab
on('change:toggle_prayerful', function(eventInfo) {

    const output = {};
    output['show_prayerful'] = eventInfo.newValue;
    setAttrs(output);
});

// Whisper toggle
on('change:toggle_whisper', function(eventInfo) {
    const toggleValue = eventInfo.newValue.toString();

    const output = {};
    output['whispertoggle'] = (toggleValue == 'on' ? '/w gm' : EMPTY_STRING);
    setAttrs(output);
});

/**************************************************
** Overview Tab
***************************************************/
// Attribute Modifiers
// Update the character's attribute modifer, by attribute.
on('change:str change:int change:wil change:dex change:con change:cha', function(eventInfo) {
    const theAttr = eventInfo.sourceAttribute;
    getAttrs([theAttr], function(values) {
        const attrValue = parseInt(values[theAttr]) || ATTR_SCORE_DEFAULT;
        
        const attrModifiers = [-5,-4,-3,-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2,3,4,5]; //ACKS modifiers

        const attrBonus = attrModifiers[attrValue - 1];

        const output = {};
        output[`${theAttr}_mod`] = attrBonus;
        setAttrs(output);
    });
});

// Attribute Nominal Values
// Copy the character's current attribute values to the Nominal (max) column.
on('clicked:save_attrs', function(eventInfo) {
    const theAttrs = ['str', 'int', 'wil', 'dex', 'con', 'cha'];
    getAttrs(theAttrs, function(values) {
        const output = {};
        theAttrs.forEach((element) => {
            output[`${element}_max`] = parseInt(values[element]) || ATTR_SCORE_DEFAULT;
        });
        setAttrs(output);
    });
});

// Attribute Roller (PC)
// Randomly generate a set of attributes
on('clicked:roll_PC', function(eventInfo) {
    const rolls = [];
    rolls.push(rollDice(5, 6, 2));
    rolls.push(rollDice(4, 6, 1));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    const attributes = shuffleArray(rolls);

    const theAttrs = ['str', 'int', 'wil', 'dex', 'con', 'cha'];
    getAttrs(theAttrs, function(values) {
        const output = {};
        while (rolls.length > 0) {
            theAttrs.forEach((element) => { 
                output[element] = rolls.pop();
            });
        }
        setAttrs(output);
    });
});

// Attribute Roller (0th level)
// Randomly generate a set of attributes
on('clicked:roll_0th', function(eventInfo) {
    const rolls = [];
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));
    rolls.push(rollDice(3));


    const attributes = shuffleArray(rolls);

    const theAttrs = ['str', 'int', 'wil', 'dex', 'con', 'cha'];
    getAttrs(theAttrs, function(values) {
        const output = {};
        while (rolls.length > 0) {
            theAttrs.forEach((element) => { 
                output[element] = rolls.pop();
            });
        }
        setAttrs(output);
    });
});

// Bedrest
// If the character requires bedrest, highlight the field.
on('change:bedrest', function(eventInfo) {
    getAttrs(['bedrest'], function (values) {
        const bedrestDays = parseInt(values.bedrest) || 0;

        const output = {};
        output['is_bedrest'] = (bedrestDays > 0 ? 1 : 0);
        setAttrs(output);
    });
});

// Experience Points
// Update the character's total XP earned to-date
on('change:repeating_experience:xp_amount change:repeating_experience:xp_bonus remove:repeating_experience', function(eventInfo) {
    getSectionIDs('repeating_experience', function (ids) {
        const XPFieldnames = [];
        ids.forEach(id => {
            XPFieldnames.push(`repeating_experience_${id}_xp_amount`);
            XPFieldnames.push(`repeating_experience_${id}_xp_bonus`);
        });
        
        getAttrs([...XPFieldnames], function (values) {
            let totalXP = 0;
            const output = {};
            ids.forEach(id => {
                const itemXP = parseFloat(values[`repeating_experience_${id}_xp_amount`]) || 0;
                const xpBonus = parseFloat(values[`repeating_experience_${id}_xp_bonus`]) || 0;
                totalXP += Math.floor(itemXP + (itemXP * (xpBonus / 100)));
            });
            output['xp'] = totalXP;
            setAttrs(output);
        });
    });
});

// Experience Point Bonus
// Calculate the character's XP bonus, based on their key attribute selection(s).
on('change:str change:int change:wil change:dex change:con change:cha change:str_pre change:int_pre change:wil_pre change:dex_pre change:con_pre change:cha_pre change:xp_modifier', function(eventInfo) {
    getAttrs(['str', 'int', 'wil', 'dex', 'con', 'cha', 'str_pre', 'int_pre', 'wil_pre', 'dex_pre', 'con_pre', 'cha_pre', 'xp_modifier'], function(values) {
        const attributeValues = [parseInt(values.str) || 0,parseInt(values.int) || 0,parseInt(values.wil) || 0,parseInt(values.dex) || 0,parseInt(values.con) || 0,parseInt(values.cha) || 0];
        const keyAttributes = [parseInt(values.str_pre) || 0,parseInt(values.int_pre) || 0,parseInt(values.wil_pre) || 0,parseInt(values.dex_pre) || 0,parseInt(values.con_pre) || 0,parseInt(values.cha_pre) || 0];
        const theXPModifier = parseInt(values.xp_modifier) || 0;
        
        const output = {};
        let theXPBonus = XP_BONUS_MAX;
        let noKeyAttribute = 1;
        for (var i = 0; i < 6; i++) {
            if (keyAttributes[i] == 1) {
                theXPBonus = Math.min(theXPBonus,(attributeValues[i] > 15 ? 10 : (attributeValues[i] > 12 ? 5 : 0)));
                noKeyAttribute = 0;
            }
        }
        output['xp_bonus'] = (noKeyAttribute == 1 ? 0 : (theXPBonus + theXPModifier));
        setAttrs(output); 
    });
});

// Fatigue
// If the character is fatigued, highlight the field.
on('change:fatigue', function(eventInfo) {
    getAttrs(['fatigue'], function (values) {
        const fatigueLevel = Number(values['fatigue']) || 0;

        const output = {};
        output['is_fatigued'] = (fatigueLevel > 0 ? 1 : 0);
        setAttrs(output);
    });
});

// Hit Dice
// Validate a character's hit dice formula.
// If invalid, highlight the field.
// If valid, save the number of HD for future use.
on('change:hit_dice', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        getAttrs(['hit_dice'], function(values) {
            const validatedFormula = validateDieFormula(values.hit_dice);

            const output = {};
            output['hit_dice'] = validatedFormula; 
            if (validatedFormula == EMPTY_STRING) {
                output['isBadHDFormula'] = 1;
                output['numHD'] = 0;
            } else {
                output['isBadHDFormula'] = 0;
                output['numHD'] = getNumHitDice(validatedFormula);
            }
            setAttrs(output);
        });
    }
});

// Helper to return just the number of hit dice.
// Assumes that the die formula has already been validated!
// (See validateDieFormula() for more details.)
function getNumHitDice(theHDFormula) {
    const theDelimiter = theHDFormula.toLowerCase().indexOf(DIE_DELIMITER);

    return theHDFormula.slice(0,theDelimiter);
}

// Hit Points
// SIf the character's hit points are below 1, highlight the field.
on('change:hp', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        getAttrs(['hp', 'hp_max'], function(values) {
            const theHP = parseInt(values['hp']) || 0;
            const theHPMax = parseInt(values['hp_max']) || 0;

            const validatedHP = theHP > theHPMax ? theHPMax : theHP;

            const output = {};
            output['hp_is_below_one'] = (validatedHP < 1 ? 1 : 0);
            setAttrs(output);
        });
    }
});

// Saving Throws
on('change:save_profile change:class_save_bonus change:save_1_base change:save_1_mod change:save_2_base change:save_2_mod change:save_3_base change:save_3_mod change:save_4_base change:save_4_mod change:save_5_base change:save_5_mod', function(eventInfo) {
    if (eventInfo.sourceAttribute == 'save_profile') {
        updateSaveProfile();
    }
    else if (eventInfo.sourceAttribute == 'class_save_bonus') {
        updateSaveModifiers();
    } else {
        const theSourceAttr = eventInfo.sourceAttribute;
        const theSaveIndex = parseInt(theSourceAttr.slice(5,6)) || 0;
        UpdateSaveTarget(theSaveIndex);
    }
});

// Loop through saves and set all modifiers to the class save bonus.
function updateSaveModifiers() {
    getAttrs(['class_save_bonus', 'save_1_mod', 'save_2_mod', 'save_3_mod', 'save_4_mod', 'save_5_mod'], function(values) {
        const saveBonus = parseInt(values.class_save_bonus) || 0;

        const output = {};
        for (var i = 1; i < 6; i++) { output[`save_${i}_mod`] = -saveBonus; };
        setAttrs(output);
    });
    updateSaveTargets(); // Now go update the targets
};

// Apply class-based save values
// Using an 'XY' code string, where
//  'X' = class letter [C,F,M, or T] (see ACKS)
//  'Y' = class level [0-15]
function updateSaveProfile() {
    getAttrs(['save_profile'], function(values) {
        const saveString = values.save_profile;
        
        // ACKS II saving throw schedules, by level (incl. level 0)
        const clericSaves = [14,15,16,17,18,13,10,16,13,15,13,10,16,13,15,12,9,15,12,14,12,9,15,12,14,11,8,14,11,13,11,8,14,11,13,10,7,13,10,12,10,7,13,10,12,9,6,12,9,11,9,6,12,9,11,8,5,11,8,10,8,5,11,8,10,7,4,10,7,9,7,4,10,7,9,6,3,9,6,8,6,3,9,6,8,5,2,8,5,7,5,2,8,5,7,4,1,7,4,6,4,1,7,4,6];
        const fighterSaves = [14,15,16,17,18,13,14,15,16,17,12,13,14,15,16,12,13,14,15,16,11,12,13,14,15,10,11,12,13,14,10,11,12,13,14,9,10,11,12,13,8,9,10,11,12,8,9,10,11,12,7,8,9,10,11,6,7,8,9,10,6,7,8,9,10,5,6,7,8,9,4,5,6,7,8,4,5,6,7,8,3,4,5,6,7,2,3,4,5,6,2,3,4,5,6,1,2,3,4,5,0,1,2,3,4];
        const mageSaves = [14,15,16,17,18,13,13,15,11,12,13,13,15,11,12,13,13,15,11,12,12,12,14,10,11,12,12,14,10,11,12,12,14,10,11,11,11,13,9,10,11,11,13,9,10,11,11,13,9,10,10,10,12,8,9,10,10,12,8,9,10,10,12,8,9,9,9,11,7,8,9,9,11,7,8,9,9,11,7,8,8,8,10,6,7,8,8,10,6,7,8,8,10,6,7,7,7,9,5,6,7,7,9,5,6];
        const thiefSaves = [14,15,16,17,18,13,13,13,14,15,13,13,13,14,15,12,12,12,13,14,12,12,12,13,14,11,11,11,12,13,11,11,11,12,13,10,10,10,11,12,10,10,10,11,12,9,9,9,10,11,9,9,9,10,11,8,8,8,9,10,8,8,8,9,10,7,7,7,8,9,7,7,7,8,9,6,6,6,7,8,6,6,6,7,8,5,5,5,6,7,5,5,5,6,7,4,4,4,5,6,4,4,4,5,6];

        const saveClass = saveString.slice(0,1);
        const saveLevel = Math.max(Math.min(Number(saveString.slice(1,2)) || 0,20),0);

        let appliedSaves = [];
        switch (saveClass) { 
            case 'C': appliedSaves = clericSaves; break;
            case 'F': appliedSaves = fighterSaves; break;
            case 'M': appliedSaves = mageSaves; break;
            case 'T': appliedSaves = thiefSaves; break;
            default: return;
        }
        
        const output = {};
        for (var i = 0; i < 5; i++ ) { output['save_' + (i + 1) + '_base'] = appliedSaves[(saveLevel) * 5 + i]};
        setAttrs(output);
    });
    updateSaveTargets(); // Now go update the targets
};

// Update a save target
function UpdateSaveTarget(index) {
    getAttrs([`save_${index}_base`, `save_${index}_mod`], function(values) {
        theBaseValue = parseInt(values[`save_${index}_base`]) || 0;
        theModValue = parseInt(values[`save_${index}_mod`]) || 0;

        const output = {};
        output[`save_${index}`] = Math.max(SAVE_MIN_TARGET, theBaseValue + theModValue);
        setAttrs(output);
    }); 
};

//Update all the save targets
function updateSaveTargets() {
    for (var index = 1; index < 6; index++) {
        UpdateSaveTarget(index);
    };    
};


/**************************************************
** Class Tab
***************************************************/
// Show/hide the Code of Behavior section
on('change:toggle_behavior', function(eventInfo) {

    const output = {};
    output['show_behavior'] = eventInfo.newValue;
    setAttrs(output);
});

/**************************************************
** Combat Tab
***************************************************/
// Armor Class
// Update the character's armor class.
on('change:armor change:armor_bonus change:has_shield change:class_ac_bonus change:dex_mod change:fss_shield', function(eventInfo) {
    getAttrs(['armor', 'armor_bonus', 'has_shield', 'class_ac_bonus', 'dex_mod', 'fss_shield'], function(values) {
        const theArmorIndex = parseInt(values.armor) || 0; // base AC
        const theArmorBonus = parseInt(values.armor_bonus) || 0; // magic bonus, if any
        const hasShield = parseInt(values.has_shield) || 0; // shield (+1 AC)
        const classACBonus = parseInt(values.class_ac_bonus) || 0; // class bonus, if any
        const theDexMod = parseInt(values.dex_mod) || 0; // dex modifier
        const theFSSMod = parseInt(values.fss_shield) || 0; // FSS modifier, if any

        const theAC = Math.max(0, theArmorIndex + theArmorBonus + hasShield + classACBonus + theDexMod + theFSSMod);
        
        const output = {};
        output['armor_class'] = theAC;
        setAttrs(output);
    });
});

// Damage Attribute
// Changes the character's attribute modifier applied to their damage rolls.
on('change:select_damage_attr', function(eventInfo) {
    getAttrs(['select_damage_attr'], function(values) {
        const theNewAttribute = values['select_damage_attr'];

        const output = {};
        output['damage_attr'] = `@{${theNewAttribute}_mod}[${theNewAttribute}]`;
        setAttrs(output);
    });
});

// Damage Formula Validation
// Ensures that a valid damage dice formula exists
// Melee attacks...
on('change:repeating_melee:melee_name change:repeating_melee:melee_damage', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        getAttrs(['repeating_melee_melee_damage'], function(values) {
            const validatedFormula = validateDieFormula(values.repeating_melee_melee_damage);

            const output = {};
            output['repeating_melee_melee_damage'] = validatedFormula;
            output['repeating_melee_isBadDmgFormula'] = (validatedFormula == EMPTY_STRING ? 1 : 0);
            setAttrs(output);
        });
    }
});
// Missile attacks...
on('change:repeating_missile:missile_name change:repeating_missile:missile_damage', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        getAttrs(['repeating_missile_missile_damage'], function(values) {
            const validatedFormula = validateDieFormula(values.repeating_missile_missile_damage);

            const output = {};
            output['repeating_missile_missile_damage'] = validatedFormula;
            output['repeating_missile_isBadDmgFormula'] = (validatedFormula == EMPTY_STRING ? 1 : 0);
            setAttrs(output);
        });
    }
});

// Dual Wield
// If dual-wield, turn off 2-handed
on('change:repeating_melee:melee_is_dual', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        const output = {};
        output['repeating_melee_melee_is_2h'] = 0;
        setAttrs(output);
    }
});

// Fighting Style Specialization
// Update the character's ACKS FSS state.
on('change:fss', function(eventInfo) {
    getAttrs(['fss'], function(values) {
        const fssID = parseInt(values.fss) || 0; // selected FSS option

        const output = {};
        output['fss_missile'] = (fssID == 1 ? 1 : 0);
        output['fss_single'] = (fssID == 2 ? 1 : 0);
        output['fss_dual'] = (fssID == 3 ? 2 : 1);
        output['fss_two'] = (fssID == 4 ? 1 : 0);
        output['fss_shield'] = (fssID == 5 ? 1 : 0);
        setAttrs(output);
    });
});

// Missile Attack
// Roll the character's missile attack.
// Subtract 1 from the attack's ammunition field.
// Note: Required to both roll the attack and auto-deduct the ammo.
on('clicked:repeating_missile:missile-attack', () => {
    getAttrs(['repeating_missile_missile_name', 'repeating_missile_missile_bonus', 'repeating_missile_missile_damage', 'repeating_missile_missile_is_thrown', 'repeating_missile_missile_effects', 'repeating_missile_missile_ammo'], function(values) {
        const missileName = values.repeating_missile_missile_name;
        const missileBonus = parseInt(values.repeating_missile_missile_bonus) || 0;
        const missileDamage = values.repeating_missile_missile_damage;
        const missileIsThrown = parseInt(values.repeating_missile_missile_is_thrown) || 0;
        const missileEffects = values.repeating_missile_missile_effects;
        const missileAmmo = parseInt(values.repeating_missile_missile_ammo) || 0;

        startRoll(`@{whispertoggle} &{template:custom} {{title=@{banner_missile} **Missile Attack Throw**}} {{subtitle=@{character_title} @{selected|token_name}}} {{color=red}} {{Attack/Weapon=${missileName}}} {{Ammo Remaining=${missileAmmo - 1}}} {{Target=[[@{attack_throw}+(?{Target AC|0}[target AC])]]}} {{Roll=[[1d20+@{dex_mod}[dex]+${missileBonus}[wpn]+?{Range|Short,0|Medium,-2|Long,-5}[range]+@{class_damage_bonus_missile}[class]+@{fss_missile}[fss]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}} {{damage=[[{${missileDamage}+(${missileIsThrown}*@{damage_attr})+(@{class_damage_bonus_missile}[class])-@{fatigue}[fatigue], 0d1+1}k1]]}} {{effects=${missileEffects}}}`, roll => {  
          finishRoll(roll.rollId);
        });

        const output = {};
        output['repeating_missile_missile_ammo'] = missileAmmo - 1;
        setAttrs(output); 
    });
});

// Two-handed Wield
// If 2-handed weapon, turn off dual-wield
on('change:repeating_melee:melee_is_2h', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        const output = {};
        output['repeating_melee_melee_is_dual'] = 0;
        setAttrs(output);
    }
});

// Weapon Finesse
// Toggle the character's Weapon Finesse attribute modifier.
on('change:repeating_melee:melee_is_finesse', function(eventInfo) {
    getAttrs(['repeating_melee_melee_is_finesse'], function(values) {
        const isFinesse = parseInt(values.repeating_melee_melee_is_finesse) || 0;
        
        const output = {};
        output['repeating_melee_melee_attk_attr'] = (isFinesse == true ? ATTR_MELEE_MOD_FINESSE : ATTR_MELEE_MOD_DEFAULT);
        setAttrs(output); 
    });
});

/**************************************************
** Studious Tab
***************************************************/
// Spell Slots, Reset
// Reset the character's daily casting slots remaining.
on('clicked:reset_studious_spells', function(eventInfo) {
    getAttrs(['studious_1_max', 'studious_2_max', 'studious_3_max', 'studious_4_max', 'studious_5_max', 'studious_6_max', 'studious_7_max', 'studious_8_max', 'studious_9_max'], function(values) {
        
        const output = {};
        for (var i = 1; i < 10; i++) {
            const slotValue = parseInt(values[`studious_${i}_max`]) || 0;
            output[`studious_${i}`] = slotValue;
        }
        setAttrs(output);
    });
});

/**************************************************
** Prayerful Tab
***************************************************/
// Spell Slots, Reset
// Reset the character's daily casting slots remaining.
on('clicked:reset_prayerful', function(eventInfo) {
    getAttrs(['prayerful_1_max', 'prayerful_2_max', 'prayerful_3_max', 'prayerful_4_max', 'prayerful_5_max', 'prayerful_6_max', 'prayerful_7_max', 'prayerful_8_max', 'prayerful_9_max'], function(values) {
        
        const output = {};
        for (var i = 1; i < 10; i++) {
            const slotValue = parseInt(values[`prayerful_${i}_max`]) || 0;
            output[`prayerful_${i}`] = slotValue;
        }
        setAttrs(output);
    });
});

/**************************************************
** Skills Tab
***************************************************/

/**************************************************
** Equip Tab
***************************************************/
// Encumbrance
// Update the character's total encumbrance.
// Highlight field if total exceeds min. threshold and setting is on.
// Update the character's currency capacity remaining.
on('change:currency_weight change:items_weight change:enc_capacity change:enc_alert_toggle change:move_alertThresh', function(eventInfo) {
    getAttrs(['currency_weight', 'items_weight', 'enc_capacity', 'enc_alert_toggle', 'move_alertThresh'], function(values) {
        const theCurrencyWeight = parseFloat(values.currency_weight) || 0;
        const theItemWeight = parseFloat(values.items_weight) || 0;
        const theMaxCapacity = parseInt(values.enc_capacity) || 0;
        const theThresholdLimit = parseInt(values.move_alertThresh) || 0;
        const encAlertToggle = parseInt(values.enc_alert_toggle) || 0;
        
        const theEncumbrance = theCurrencyWeight + theItemWeight;
        const theCurrencyCapacity = (theMaxCapacity - theEncumbrance) / COIN_WEIGHT;

        const output = {};
        output['encumbrance'] = Math.ceil(theEncumbrance);
        output['enc_over_five'] = (encAlertToggle == true ? (theEncumbrance > theThresholdLimit ? 1 : 0) : 0);
        output['currency_capacity'] = Math.ceil(theCurrencyCapacity);
        setAttrs(output);
    });
});

// Encumbrance Capacity
// Update the character's encumbrance capacity.
on('change:str_mod change:base_enc', function(eventInfo) {
    getAttrs(['str_mod', 'base_enc'], function(values) {
        const strMod = parseInt(values.str_mod) || 0;
        const baseEnc = parseInt(values.base_enc) || 0;

        const encCapacity = baseEnc + strMod;

        const output = {};
        output['enc_capacity'] = encCapacity;
        setAttrs(output);
    });
});

// Encumbrance, Items
// Update the character's item encumbrance whenever an item is...
//  added, removed, equipped, unequipped,
//  the count is changed, or its unit weight has changed
on('change:repeating_items:item_name change:repeating_items:item_weight change:repeating_items:item_count change:repeating_items:item_equipped remove:repeating_items', function(eventInfo) {
    if (eventInfo.sourceType == "player") updateItemEncumbrance(
        'repeating_items', 
        '_item_weight',
        '_item_count',
        '_item_equipped',
        'items_weight'
        );
});

// Helper function to compute item encumbrance weight.
function updateItemEncumbrance(
    repeatingName, 
    encPropName,
    countPropName,
    equippedPropName,
    outputName) {
    getSectionIDs(repeatingName, function (ids) {
        const encFieldnames = [];
        const countFieldnames = [];
        const equippedFieldnames = [];
        ids.forEach(id => {
            encFieldnames.push(`${repeatingName}_${id}${encPropName}`);
            countFieldnames.push(`${repeatingName}_${id}${countPropName}`);
            equippedFieldnames.push(`${repeatingName}_${id}${equippedPropName}`);
        });
        
        getAttrs([...encFieldnames, ...countFieldnames, ...equippedFieldnames], function (values) {
            const output = {};
            let totalEnc = 0;
            ids.forEach(id => {
                const itemEnc = parseFloat(values[`${repeatingName}_${id}${encPropName}`]);
                const itemCount = parseFloat(values[`${repeatingName}_${id}${countPropName}`])||0;
                const equipped = parseInt(values[`${repeatingName}_${id}${equippedPropName}`]);

                totalEnc += equipped == 1 ? itemEnc * itemCount : 0;
            });
            output[outputName] = totalEnc;
            setAttrs(output);
        });
    });
};

// Movement Speed
// Update the character's movement speed and related stats.
on('change:enc_capacity change:encumbrance change:base_movement change:move_thresh1 change:move_thresh2 change:move_thresh3', function(eventInfo) {
    getAttrs(['enc_capacity', 'encumbrance', 'base_movement', 'move_thresh1', 'move_thresh2', 'move_thresh3'], function(values) {
        const encCapacity = parseInt(values.enc_capacity) || 0;
        const theEncumbrance = parseInt(values.encumbrance) || 0;
        const movementBase = parseInt(values.base_movement) || 0;
        const moveThresh1 = parseInt(values.move_thresh1) || 0;
        const moveThresh2 = parseInt(values.move_thresh2) || 0;
        const moveThresh3 = parseInt(values.move_thresh3) || 0;

        const moveThresholds = [(moveThresh1 + .01),(moveThresh2 + .01),(moveThresh3 + .01),encCapacity+.01,999];
        const moveThresholdIndex = moveThresholds.findIndex(element => theEncumbrance < element);

        const moveSpeeds = [movementBase,(movementBase * .75),(movementBase * .5),(movementBase * .25),0]; //ACKS Core, pg. 48
        const theMovementSpeed = moveSpeeds[moveThresholdIndex];
        const isMovementZero = theMovementSpeed > 0 ? 0 : 1;
        
        const output = {};
        output['move_turn'] = Math.round(theMovementSpeed);
        output['move_round'] = Math.round(theMovementSpeed / 3);
        output['miles_day'] = Math.round(theMovementSpeed / 5);
        output['miles_hour'] = theMovementSpeed / 40;
        output['move_is_zero'] = isMovementZero;
        setAttrs(output);
    });
});

/**************************************************
** Wealth Tab
***************************************************/
// Cost of Living
// Update the character's total monthly cost of living.
on('change:living_standard change:hireling_fees change:professional_income', function(eventInfo) {
    getAttrs(['living_standard', 'hireling_fees', 'professional_income'], function(values) {
        const theLivingStandard = parseInt(values.living_standard) || 0;
        const theHirelingFees = parseInt(values.hireling_fees) || 0;
        const theProIncome = parseInt(values.professional_income) || 0;
        
        const totalMonthlyFees = 0 - (theLivingStandard + theHirelingFees) + theProIncome;

        const output = {};
        output['monthly_balance'] = totalMonthlyFees;
        setAttrs(output);
    });
});

// Currency, Encumbrance
// Update the character's encumbrance from non-Banked currency.
on('change:gold change:silver change:copper change:electrum change:platinum change:gold_found change:silver_found change:copper_found change:electrum_found change:platinum_found', function(eventInfo) {
    getAttrs(['gold', 'silver', 'copper', 'electrum', 'platinum', 'gold_found', 'silver_found', 'copper_found', 'electrum_found', 'platinum_found'], function(values) {
        const coinsGold = parseInt(values.gold) || 0;
        const coinsSilver = parseInt(values.silver) || 0;
        const coinsCopper = parseInt(values.copper) || 0;
        const coinsElectrum = parseInt(values.electrum) || 0;
        const coinsPlatinum = parseInt(values.platinum) || 0;
        const coinsGoldFound = parseInt(values.gold_found) || 0;
        const coinsSilverFound = parseInt(values.silver_found) || 0;
        const coinsCopperFound = parseInt(values.copper_found) || 0;
        const coinsElectrumFound = parseInt(values.electrum_found) || 0;
        const coinsPlatinumFound = parseInt(values.platinum_found) || 0;
        
        const totalCoins = 
            coinsGold + 
            coinsSilver + 
            coinsCopper + 
            coinsElectrum + 
            coinsPlatinum +
            coinsGoldFound + 
            coinsSilverFound + 
            coinsCopperFound + 
            coinsElectrumFound + 
            coinsPlatinumFound;
        const totalWeight = totalCoins * COIN_WEIGHT;

        const output = {};
        output['currency_weight'] = totalWeight;
        setAttrs(output);
    });
});

// Currency, New > On Hand
// Move currency values from the character's New column to their On Hand column.
// Then, recalculate the character's total On Hand values.
on('clicked:claim_currency', function(eventInfo) {
    getAttrs(['gold', 'silver', 'copper', 'electrum', 'platinum', 'gold_found', 'silver_found', 'copper_found', 'electrum_found', 'platinum_found'], function(values) {
        const coinsGold = parseInt(values.gold) || 0;
        const coinsSilver = parseInt(values.silver) || 0;
        const coinsCopper = parseInt(values.copper) || 0;
        const coinsElectrum = parseInt(values.electrum) || 0;
        const coinsPlatinum = parseInt(values.platinum) || 0;
        const coinsGoldFound = parseInt(values.gold_found) || 0;
        const coinsSilverFound = parseInt(values.silver_found) || 0;
        const coinsCopperFound = parseInt(values.copper_found) || 0;
        const coinsElectrumFound = parseInt(values.electrum_found) || 0;
        const coinsPlatinumFound = parseInt(values.platinum_found) || 0;

        const output = {};
        output['gold'] = coinsGold + coinsGoldFound;
        output['silver'] = coinsSilver + coinsSilverFound;
        output['copper'] = coinsCopper + coinsCopperFound;
        output['electrum'] = coinsElectrum + coinsElectrumFound;
        output['platinum'] = coinsPlatinum + coinsPlatinumFound;
        output['gold_found'] = output['silver_found'] = output['copper_found'] = output['electrum_found'] = output['platinum_found'] = 0;
        setAttrs(output);
    });
});

// Wealth, Currency
// Update the charater's total Wealth from currency.
on('change:gold change:silver change:copper change:electrum change:platinum change:gold_bank change:silver_bank change:copper_bank change:electrum_bank change:platinum_bank', function(eventInfo) {
    getAttrs(['gold', 'silver', 'copper', 'electrum', 'platinum', 'gold_bank', 'silver_bank', 'copper_bank', 'electrum_bank', 'platinum_bank'], function(values) {
        const coinsGold = parseInt(values.gold) || 0;
        const coinsSilver = parseInt(values.silver) || 0;
        const coinsCopper = parseInt(values.copper) || 0;
        const coinsElectrum = parseInt(values.electrum) || 0;
        const coinsPlatinum = parseInt(values.platinum) || 0;
        const coinsGoldBank = parseInt(values.gold_bank) || 0;
        const coinsSilverBank = parseInt(values.silver_bank) || 0;
        const coinsCopperBank = parseInt(values.copper_bank) || 0;
        const coinsElectrumBank = parseInt(values.electrum_bank) || 0;
        const coinsPlatinumBank = parseInt(values.platinum_bank) || 0;
        
        const totalWealth = 
            Math.floor((
            coinsGold*100 +  
            coinsSilver*10 + 
            coinsCopper +
            coinsElectrum*50 +
            coinsPlatinum*500 +
            coinsGoldBank*100 + 
            coinsSilverBank*10 + 
            coinsCopperBank +
            coinsElectrumBank*50 +
            coinsPlatinumBank*500
            )/100); // Convert all to copper, then back to gold

        const output = {};
        output['currency_wealth'] = totalWealth;
        setAttrs(output);
    });
});

/**************************************************
** Hirelings Tab
***************************************************/
// Henchmen Fees
// Calculate the character's monthly henchmen fees.
on('change:repeating_henchmen:henchman_name change:repeating_henchmen:henchman_fee remove:repeating_henchmen', function(eventInfo) {
    getSectionIDs('repeating_henchmen', function (ids) {
        const feeHenchFieldnames = [];
        ids.forEach(id => {
            feeHenchFieldnames.push(`repeating_henchmen_${id}_henchman_fee`);
        });
        
        getAttrs([...feeHenchFieldnames], function (values) {
            let totalFees = 0;
            const output = {};
            ids.forEach(id => {
                console.log('fee: ' + values[`repeating_henchmen_${id}_henchman_fee`]);
                const itemFee = parseFloat(values[`repeating_henchmen_${id}_henchman_fee`])||0;
                totalFees += itemFee;
            });
            output['henchmen_fees'] = totalFees;
            setAttrs(output);
        });
    });
});

// Recalculate a character's henchman monthly fee, based on the henchman's level
on('change:repeating_henchmen:henchman_level', function(eventInfo) {
    const theLevel = eventInfo.newValue;
    const theRowId = getID(eventInfo.sourceAttribute);
    const henchmenFees = [12,25,50,100,200,400,800,1600,3000,7250,12000,32000,50000,135000,350000]; // Fee schedule, by level
    
    const output = {};
    output[`repeating_henchmen${theRowId}_henchman_fee`] = henchmenFees[theLevel];
    setAttrs(output);
});

// Henchmen Limit
// Calculate the character's henchmen limit.
on('change:cha_mod change:class_hireling_loyalty_bonus', function(eventInfo) {
    getAttrs(['cha_mod', 'class_hireling_loyalty_bonus'], function(values) {
        const chaMod = parseInt(values.cha_mod) || 0;
        const loyaltyBonus = parseInt(values.class_hireling_loyalty_bonus) || 0;
        
        const output = {};
        output['henchmen_limit'] = HENCHMEN_LIMIT + chaMod + loyaltyBonus;
        setAttrs(output);
    });
});

// If the character's number of henchmen exceed their limit, highlight the field.
on('change:repeating_henchmen:henchman_name remove:repeating_henchmen change:henchmen_limit', function(eventInfo) {
    getAttrs(['henchmen_limit'], function(values) {
        const henchmenLimit = parseInt(values.henchmen_limit) || HENCHMEN_LIMIT;

        getSectionIDs('repeating_henchmen', function (ids) {
            const numHenchmen = ids.length;
            
            const output = {};
            output['henchmen_count'] = (numHenchmen > henchmenLimit ? 1: 0);
            setAttrs(output);
        });
    });
});

// Hireling Fees
// Calculate the character's total monthly hireling fees.
// (Henchmen, mercenaries, and specialists.)
on('change:henchmen_fees change:mercenary_fees change:specialist_fees', function(eventInfo) {
    getAttrs(['henchmen_fees', 'mercenary_fees', 'specialist_fees'], function (values) {
        const theHenchmenFees = Number(values['henchmen_fees']) || 0;
        const theMercenaryFees = Number(values['mercenary_fees']) || 0;
        const theSpecialistFees = Number(values['specialist_fees']) || 0;

        const output = {};
        output['hireling_fees'] = theHenchmenFees + theMercenaryFees + theSpecialistFees;
        setAttrs(output);
    });
});

// Mercenary Fees
// Calculate the character's monthly mercenary fees.
on('change:repeating_mercenaries:merc_fee change:repeating_mercenaries:merc_number remove:repeating_mercenaries', function(eventInfo) {
    getSectionIDs('repeating_mercenaries', function (ids) {
        const feeMercFieldnames = [];
        const numMercFieldnames = [];
        ids.forEach(id => {
            feeMercFieldnames.push(`repeating_mercenaries${id}_merc_fee`);
            numMercFieldnames.push(`repeating_mercenaries${id}_merc_number`);
        });
        
        getAttrs([...feeMercFieldnames, ...numMercFieldnames], function (values) {
            let totalFees = 0;
            const output = {};
            ids.forEach(id => {
                const itemFee = parseFloat(values[`repeating_mercenaries${id}_merc_fee`])||0;
                const itemNum = parseFloat(values[`repeating_mercenaries${id}_merc_number`])||0;                
                totalFees += itemFee * itemNum;
                output[`repeating_mercenaries_${id}_merc_fees`] = totalFees; // Update each merc's total fee
            });
            output['mercenary_fees'] = totalFees; // Update total of all merc fees
            setAttrs(output);
        });
    });
});

// Specialist Fees
// Calculate the character's monthly specialist fees.
on('change:repeating_specialists:spec_fee remove:repeating_specialists', function(eventInfo) {
    getSectionIDs('repeating_specialists', function (ids) {
        const feeSpecFieldnames = [];
        ids.forEach(id => {
            feeSpecFieldnames.push(`repeating_specialists${id}_spec_fee`);
        });
        
        getAttrs([...feeSpecFieldnames], function (values) {
            let totalFees = 0;
            const output = {};
            ids.forEach(id => {
                const itemFee = parseFloat(values[`repeating_specialists${id}_spec_fee`])||0;
                totalFees += itemFee;
            });
            output['specialist_fees'] = totalFees;
            setAttrs(output);
        });
    });
});

/**************************************************
** Journal Tab
***************************************************/

/**************************************************
** Settings Tab
***************************************************/
// Increment hp by one to support TENSION pool
on('clicked:add_tension', function(eventInfo) {
    getAttrs(['hp'], function(values) {
        const hp = parseInt(values.hp) || 0;

        const output = {};
        output['hp'] = hp + 1;
        setAttrs(output);
    });
});

// Rest hp to 0 to support TENSION pool
on('clicked:clear_tension', function(eventInfo) {
    const output = {};
    output['hp'] = 0;
    setAttrs(output);
});

</script>

<rolltemplate class="sheet-rolltemplate-custom">
    <div class="sheet-container sheet-color-{{color}}">
      <div class="sheet-header">
        {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
        {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
      </div>
      <div class="sheet-content">
        {{#allprops() title subtitle color damage desc effects loyalty surprise}}
        <div class="sheet-key">{{key}}</div>
        <div class="sheet-value">{{value}}</div>
        {{/allprops() title subtitle color damage desc effects loyalty surprise}}
        
        {{#effects}}
        <div class="sheet-key">Effects</div>
        <div class="sheet-value">{{effects}}</div>
        {{/effects}}

        {{#^rollLess() Roll Target}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="success">Success!</span></div>
            {{#damage}}
            <div class="sheet-key">Damage</div>
            <div class="sheet-value">{{damage}}</div>
            {{/damage}}
        {{/^rollLess() Roll Target}}
        {{#rollLess() Roll Target}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="failure">Failure!</span></div>
        {{/rollLess() Roll Target}}

        {{#rollLess() Surprise 3}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="failure">Surprised!</span></div>
        {{/rollLess() Surprise 3}}
        {{#^rollLess() Surprise 3}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="success">Unsurprised!</span></div>
        {{/^rollLess() Surprise 3}}

        {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
      </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-menu">
    <div class="sheet-container sheet-color-{{color}}">
         <div class="sheet-header">
            {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
            {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
        </div>
         <div class="sheet-content">
            {{#allprops() title subtitle desc color}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
            {{/allprops() title subtitle desc color}}
            {{#desc}}
                <div class="sheet-desc">{{desc}}</div>
            {{/desc}}
        </div>
    </div>
</rolltemplate>