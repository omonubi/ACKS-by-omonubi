<div class='pc'>
<!-- RegEx for debugging
    /\*(.*\)\1;)\*/
    /**/$1
    -----
    /\*\*/(.*\)\1;)
    /*$1*/
-->
<!-- Tab Controls -->
<div class='page-title'>
    <h2>Adventurer Conqueror King System</h2>
</div>
<div class='button-panel'>
    <input type='hidden' class='buttonstoggle' name='attr_sheetButtons' value='overview'/>
    <button type='action' class='btnOverview' name='act_overview' >Overview</button> 
    <button type='action' class='btnClass' name='act_class' >Class</button>
    <button type='action' class='btnSkills' name='act_skills' >Skills</button>
    <button type='action' class='btnCombat' name='act_combat' >Combat</button>    
    <button type='action' class='btnEquipment' name='act_equipment' >Equipment</button>   
    <button type='action' class='btnHirelings' name='act_hirelings' >Hirelings</button>
    <button type='action' class='btnJournal' name='act_journal' >Journal</button>
    <button type='action' class='btnSettings' name='act_settings' >Settings</button>
    <div class='whispertoggle'><label>Whisper Toggle: </label><input type='checkbox' name='attr_toggle_whisper' /><input type='hidden' name='attr_whispertoggle'/></div>
</div>

<input type='hidden' class='tabstoggle' name='attr_sheetTab' value='overview'/>
<!-- Character Sheet -->
<div class='overview'>
    <div class='grid11'>
        <div class='grid11'>
            <label>Character Name</label>
                <input type='text' name='attr_character_fullname' />
            <label>Class</label> 
                <div>
                    <input type='text' name='attr_class'/>
                </div>
            <label>Title</label>
                <div>
                    <input type='text' name='attr_character_title'/>
                </div>
            <label>Alignment</label>
                <input type='text' name='attr_alignment'/>
            <div><label class='xp'>Experience (+</label><span class='xpbonus' name='attr_xp_bonus'>0</span><label>%)</label></div>
                <div>
                    <input class='xp' type='text' value='0' name='attr_xp' readonly/>
                    <input class='xp' type='text' value='0' name='attr_xp_next_level'/>
                </div>
            <label>Level</label>
                <input type='number' min='0' max='14' value='1' name='attr_level' />
                <input type='hidden' name='attr_max_level'/>
        </div>
        <div class='grid11'>
            <label>Token Name</label>
                <input type='text' name='attr_character_name' />
            <label>Gender</label>
                <input type='text' name='attr_gender'/>       
            <label>Height</label>
                <input type='text' name='attr_height'/>
            <label>Weight</label>
                <input type='text' name='attr_weight'/>
            <label>Age</label>
                <input type='number' name='attr_age' />
            <label>Hit Dice</label>
            <div>
                <input class='width45' type='text' name='attr_hit_dice' />
                <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_hd} **@{character_title} @{selected|token_name}**}} {{color=green}} {{subtitle=Hit Dice Roll}} {{Hit Dice=@{hit_dice}}} {{Roll=[[@{hit_dice}+(@{con_mod}[con]*@{level}[lvl])]]}}' name='roll_hit_dice'> Hit Points</button>
            </div>
        </div>
    </div>
    <hr/>
    <div class='grid11'>        
        <div class='grid11111'>
            <label class='spanheader'>Attribute Scores</label>
            <label></label>
            <label>Current</label>
            <label>Nominal</label>
            <label>Mod</label>
            <label>Prereq</label>
            <label>Strength:</label>
            <input type='number' value='10' min='0' max='20' name='attr_str' />
            <input type='number' value='10' name='attr_str_max'readonly/>
            <input type='number' value='0' name='attr_str_mod' readonly />
            <input type='checkbox' name='attr_str_pre'/>
            <label>Intellect:</label>
            <input type='number' value='10' min='0' max='20' name='attr_int' />
            <input type='number' value='10' name='attr_int_max'readonly/>
            <input type='number' value='0' name='attr_int_mod' readonly />
            <input type='checkbox' name='attr_int_pre'/>
            <label>Will:</label>
            <input type='number' value='10' min='0' max='20' name='attr_wis' />
            <input type='number' value='10' name='attr_wis_max'readonly/>
            <input type='number' value='0' name='attr_wis_mod' readonly />
            <input type='checkbox' name='attr_wis_pre'/>            
            <label>Dexterity:</label>
            <input type='number' value='10' min='0' max='20' name='attr_dex' />
            <input type='number' value='10' name='attr_dex_max'readonly/>
            <input type='number' value='0' name='attr_dex_mod' readonly />
            <input type='checkbox' name='attr_dex_pre'/>
            <label>Constitution:</label>
            <input type='number' value='10' min='0' max='20' name='attr_con' />
            <input type='number' value='10' name='attr_con_max'readonly/>
            <input type='number' value='0' name='attr_con_mod' readonly />
            <input type='checkbox' name='attr_con_pre'/>
            <label>Charisma:</label>
            <input type='number' value='10' min='0' max='20' name='attr_cha' />
            <input type='number' value='10' name='attr_cha_max'readonly/>
            <input type='number' value='0' name='attr_cha_mod' readonly />
            <input type='checkbox' name='attr_chr_pre'/>
        </div>
        <div class='grid1111'>
            <label class='spanheader'>Summary</label>
            <label>Hit Points</label>
                <input type='hidden' class='hpcheck' name='attr_hp_is_below_one'/>
                <input class='redhp' type='number' value='1' name='attr_hp'/> 
            <label>HP Max</label>
                <input type='number' value='1' name='attr_hp_max'/>
            <label>Armor Class</label>
                <input type='number' value='0' name='attr_armor_class' readonly/>
            <label>Attack Throw</label>
                <input type='number' value='10' name='attr_attack_throw' readonly/>
            <label>Encumbrance</label>
                <input type='number' value='0' name='attr_encumbrance' readonly />
            <label>Capacity, Max</label>
                <input type='number' value='20' name='attr_enc_capacity' readonly/>
            <label class='redtext'>Feet / Turn</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='120' name='attr_move_turn' readonly/> 
            <label class='redtext'>Feet / Round</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='40' name='attr_move_round' readonly/>
            <label class='redtext'>Miles / Day</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='24' name='attr_miles_day' readonly/>
            <label class='redtext'>Miles / Hour</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='0.75' name='attr_miles_hour' readonly/>
            <label class='redtext'>Fatigue Level</label>
                <input type='hidden' class='fatiguecheck' name='attr_is_fatigued'/>
                <input class='redfatigue' type='number' value='0' min='0' name='attr_fatigue'/>
        </div>
    </div>
    <hr/>
    <div class='grid11'>
        <div class='grid11'>
            <label class='spanheader'>Saving Throws</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_paralysis} **@{character_title} @{selected|token_name}**}} {{subtitle=Save vs. Paralysis}} {{color=orange}} {{Target=[[@{save_1}]]}} {{Roll=[[1d20[die]+@{wis_mod}[wis]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_1'> Paralysis</button>
                <input type='number' value='13' name='attr_save_1'/>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_poison} **@{character_title} @{selected|token_name}**}} {{subtitle=Save vs. Death}} {{color=orange}} {{Target=[[@{save_2}]]}} {{Roll=[[1d20[die]+@{wis_mod}[wis]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_2'> Death</button>
                <input type='number' value='14' name='attr_save_2'/>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_blast} **@{character_title} @{selected|token_name}**}} {{subtitle=Save vs. Blasts}} {{color=orange}} {{Target=[[@{save_3}]]}} {{Roll=[[1d20[die]+@{wis_mod}[wis]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_3'> Blasts</button>
                <input type='number' value='15' name='attr_save_3'/>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_spells} **@{character_title} @{selected|token_name}**}} {{subtitle=Save vs. Implements}} {{color=orange}} {{Target=[[@{save_4}]]}} {{Roll=[[1d20[die]+@{wis_mod}[wis]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_4'> Implements</button>
                <input type='number' value='16' name='attr_save_4'/>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_staffs} **@{character_title} @{selected|token_name}**}} {{subtitle=Save vs. Spells}} {{color=orange}} {{Target=[[@{save_5}]]}} {{Roll=[[1d20[die]+@{wis_mod}[wis]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_save_5'> Spells</button>
                <input type='number' value='17' name='attr_save_5'/>
        </div>
        <div class='grid1111'>
            <label class='spanheader'>Monster Stats</label>
            <label class='monster'>Alt Mode</label> 
                <input class='width45' type='text' name='attr_alt_move_mode'/> 
            <label class='monster'>Feet / Round</label> 
                <input class='width45' type='text' name='attr_alt_move'/>
            <label class='monster'>Morale</label>
                <input type='number' value='0' name='attr_morale'/>
            <label class='monster'>XP Value</label>
                <input type='number' name='attr_xp_value' />
            <label class='monster'>Save</label>
                <input class='width45' type='text' maxlength='3' name='attr_monster_save'/>
        </div>
    </div>
    <hr/>
</div>

<div class='class'>

    <div>
        <label class='spanheader'>Global (Unconditional) Class Bonuses</label>
        <div class='grid11'>
            <div class='grid8'>
                <label>Accuracy:</label> <input type='number' value='0' name='attr_class_accuracy_bonus'/>
                <label>Dmg, Melee:</label> <input type='number' value='0' name='attr_class_damage_bonus'/>
                <label>Dmg, Missile:</label> <input type='number' value='0' name='attr_class_damage_bonus_missile'/>
                <label>Dmg Reduction:</label> <input type='number' value='0' name='attr_class_damage_reduction'/>
                <label>Armor Class:</label> <input type='number' value='0' name='attr_class_ac_bonus'/>
                <label>Initiative:</label> <input type='number' value='0' name='attr_class_initiative_bonus'/>
                <label>Surprise:</label> <input type='number' value='0' name='attr_class_surprise_bonus'/>
                <label>Hench Morale:</label> <input type='number' value='0' name='attr_class_henchmen_morale_bonus'/>
            </div>
        </div>
        <hr/>
    </div>
    
    <div>
        <label class='spanheader'>Class Abilities</label>
        <textarea placeholder='Enter details...' name='attr_class_abilities'></textarea>
        <hr/>
    </div>

    <input class='showspellcasting' type='hidden' value='1' name='attr_show_spellcasting'/>
    <div class='spellcasting'>
        <div class='gridspellslots'>
            <label class='spanheader'>Spellcasting Slots by Spell Level</label>
            <label></label><label>level 1</label><label>level 2</label><label>level 3</label><label>level 4</label><label>level 5</label><label>level 6</label><label>level 7</label><label>level 8</label><label>level 9</label><label></label>
            <label>Slots</label>
            <input type='number' value='0' name='attr_spells_1_max' />
            <input type='number' value='0' name='attr_spells_2_max' />
            <input type='number' value='0' name='attr_spells_3_max' />
            <input type='number' value='0' name='attr_spells_4_max' />
            <input type='number' value='0' name='attr_spells_5_max' />
            <input type='number' value='0' name='attr_spells_6_max' />
            <input type='number' value='0' name='attr_spells_7_max' />
            <input type='number' value='0' name='attr_spells_8_max' />
            <input type='number' value='0' name='attr_spells_9_max' />
            <span></span>
            <label>Current</label>
            <input type='number' value='0' name='attr_spells_1'/>
            <input type='number' value='0' name='attr_spells_2'/>
            <input type='number' value='0' name='attr_spells_3'/>
            <input type='number' value='0' name='attr_spells_4'/>
            <input type='number' value='0' name='attr_spells_5'/>
            <input type='number' value='0' name='attr_spells_6'/>
            <input type='number' value='0' name='attr_spells_7'/>
            <input type='number' value='0' name='attr_spells_8'/>
            <input type='number' value='0' name='attr_spells_9'/>
            <button class='sheetbutton' type='action' name='act_reset_spells'>Reset</button>
        </div>
        <hr/>
        <div>
            <label class='spanheader'>Available Spells / Invocations</label>
            <input class='toggle-show' type='checkbox' name='attr_show_spelllist' checked/> show/hide
            <div class='details'>
                <fieldset class='repeating_spellsarcane'>
                    <button type='roll' value='@{selected|whispertoggle} &{template:custom} {{color=blue}} {{title=@{banner_spellcast} **@{character_title} @{selected|token_name}**}} {{subtitle=Cast Spell}} {{Spell=@{spell_name}}} {{Range=@{spell_range}}} {{Duration=@{spell_duration}}} {{desc=@{spell_details}}}' name='roll_cast_spell'> Cast</button>
                    <input type='text' placeholder='Spell name...' name='attr_spell_name'/>
                    <label>Level:</label><input type='number' min='1' max='9' value='1' name='attr_spell_level'/>
                    <label>Range:</label><input class='spellRange' type='text' name='attr_spell_range'/>
                    <label>Duration:</label><input class='spellDuration' type='text' name='attr_spell_duration'/>
                    <label>Prepared:</label><input type='checkbox' name='attr_spell_prepared'/>
                    <input type='checkbox' class='toggle-show'/><br/>
                    <div class='details'>
                        <textarea placeholder='Spell description...' name='attr_spell_details'></textarea>
                    </div>
                </fieldset>
            </div>
        </div>
        <hr/>
    </div>
  
    <div>
        <p>Designed for use with the Adventurer Conqueror King System, Imperial Imprint (v109) and published under the ACKS SRD/OGL, https://github.com/capheind/ACKS_SRD.</p>
    </div>
</div>

<div class='skills'>
    <div class='grid1'>
        <label class='spanheader'>Abilities</label>
        <div class='spanrepeater'>
            <fieldset class='repeating_abilities'>
                <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_abilitythrow} **@{character_title} @{selected|token_name}**}} {{subtitle=Ability Throw}} {{color=brown}} {{Using=@{ability_name}}} {{Target=[[@{ability_target}]]}} {{Roll=[[1d20[die]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_ability_check'> Throw</button>
                <input type='text' placeholder='Skill name...' name='attr_ability_name'/>
                <label>Source: </label><input type='text' name='attr_ability_source'/>
                <label>OnCD:</label><input type='checkbox' name='attr_ability_cooldown'/>
                <label>Details</label>
                <input type='checkbox' class='toggle-show'/><br/>
                <div class='details'>
                    <label class='detailslabel'>Target:</label><input class='skillScript' type='text' name='attr_ability_target'/><br/>
                    <textarea placeholder='Optional description...' name='attr_ability_details'></textarea>
                </div>
            </fieldset>
        </div>
    </div>
    <hr/>
    <div class='grid1'>
        <label class='spanheader'>Proficiencies</label>
        <div class='spanrepeater'>
            <fieldset class='repeating_skills'>
                <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_profthrow} **@{character_title} @{selected|token_name}**}} {{subtitle=Proficiency Throw}} {{color=brown}} {{Using=@{skill_name}}} {{Target=[[@{skill_target} - ((@{skill_rank}-1)*4)[rank]]]}} {{Roll=[[1d20[die]-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}}' name='roll_skill_check'> Throw</button>
                <input type='text' placeholder='Proficiency name...' name='attr_skill_name'/>
                <label>Rank:</label><input type='number' min='1' max='4' value='1' name='attr_skill_rank'/>
                <label>Type:</label>
                    <select name='attr_skill_type'>
                        <option selected>General</option>
                        <option>Class</option>
                        <option>Class Power</option>
                    </select>&nbsp;&nbsp;&nbsp;
                <label>Details</label>
                <input type='checkbox' class='toggle-show'/><br/>
                <div class='details'>
                    <label class='detailslabel'>Target:</label><input class='skillScript' type='text' name='attr_skill_target'/><br/>
                    <textarea placeholder='Optional description...' name='attr_skill_details'></textarea>
                </div>
            </fieldset>
        </div>
    </div>
    <hr/>
</div>

<div class='combat'>
    <div class='grid1111-c'>
        <button type='roll' class='combatbutton' value='@{whispertoggle} &{template:custom} {{title=@{banner_init} **@{selected|character_name}**}} {{subtitle=Initiative Roll}} {{Roll=[[((1d6cs0cf0+@{dex_mod}[dex]+@{class_initiative_bonus}[class]+(@{mod_initiative}[mod1])+(?{Modifier|0}[mod2])))&{tracker}]]}}' name='roll_initiative'> Initiative</button>
        <button type='roll' class='combatbutton' value='@{whispertoggle} &{template:custom} {{title=@{banner_surprise} **@{character_title} @{selected|token_name}**}} {{subtitle=Surprise Check}} {{Surprise=[[1d6cs0cf0+@{class_surprise_bonus}[class]-@{has_helm}[helm]+(@{mod_surprise}[mod1])+(?{Modifier|0}[mod2])]]}}' name='roll_surprise'> Surprise</button>
        <button type='roll' class='combatbutton' value='@{whispertoggle} &{template:custom} {{title=@{banner_reaction} **@{character_title} @{selected|token_name}**}} {{subtitle=Reaction Roll}} {{Roll=[[2d6cs0cf0+@{cha_mod}[cha]+(@{mod_reaction}[mod1])+(?{Modifier|0}[mod2])]]}} {{desc=2 or less: Hostile, attacks. 3-5: Unfriendly, may attack. 6-8: Neutral, uncertain. 9-11: Indifferent, uninterested. 12+: Friendly, helpful}}' name='roll_reaction'> Reaction</button>
        <button type='roll' class='combatbutton' value='@{whispertoggle} &{template:custom} {{title=@{banner_morale} @{selected|token_name}**}} {{subtitle=Morale Check}} {{Roll=[[2d6cs0cf0+(@{morale}[rating])+(?{Modifier|0}[mod])]]}} {{desc=2 or less: Frightened Retreat. 3-5: Morale Faltering. 6-8: Fight On. 9-11: Advance and Pursue. 12+: Victory or Death}}' name='roll_morale'> Morale</button>
        <input type='number' value='0' name='attr_mod_initiative'/>
        <input type='number' value='0' name='attr_mod_surprise'/>
        <input type='number' value='0' name='attr_mod_reaction'/>
        <input type='number' value='0' name='attr_mod_morale'/>
    </div>
    <hr/>
    <div class='grid11'>
        <div class='grid1111'>
            <label>Armor</label>
            <label>Bonus</label>
            <label>Shield</label>
            <label>Helm</label>
            <select name='attr_armor'>
                <option value='0' selected>AC 0 - Clothing Only</option>
                <option value='1'>AC 1 - Hide, Fur, Padded</option>
                <option value='2'>AC 2 - Leather, Arena</option>
                <option value='3'>AC 3 - Ring, Scale</option>
                <option value='4'>AC 4 - Chain, Laminated, Arena</option>
                <option value='5'>AC 5 - Banded, Lamellar</option>
                <option value='6'>AC 6 - Plate</option>
            </select>
            <input type='number' value='0' name='attr_armor_bonus'/>
            <input type='checkbox' value='1' name='attr_has_shield'/>
            <input type='checkbox' value='1' name='attr_has_helm'/>
        </div>
        <div class='grid11'>            
            <label>Armor Class</label>
            <label>Fighting Style Specialization</label>
            <input type='number' value='0' name='attr_armor_class' readonly/>
            <select name='attr_fss'>
                <option value='0' selected>None</option>
                <option value='1'>Missile Weapon (+1 Atk)</option>
                <option value='2'>Single Weapon (+1 Init)</option>
                <option value='3'>Dual Weapons (+1 Atk)</option>
                <option value='4'>Two-Handed (+1 Dmg)</option>
                <option value='5'>Wpn & Shield (+1 AC)</option>
            </select>
        </div>
    </div>
    <hr/>
    <div class='grid11'>
        <div class='grid1111'>
            <label>Attack Throw</label>
                <input type='number' min='-9' max='12' value='10' name='attr_attack_throw'/>
            <label>Max Cleaves</label>
                <input type='number' min='0' max='14' value='0' name='attr_max_cleaves'/>
        </div>
        <div class='grid11'> 
            <label>Number of Attacks: </label>
                <input type='text' value='1 (weapon)' name='attr_num_attacks'/>
        </div>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Melee Attacks</label>
        <fieldset class='repeating_melee'>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_melee} **@{character_title} @{selected|token_name}**}} {{subtitle=Melee Attack (@{melee_name})}} {{color=red}} {{Target=[[@{attack_throw}+(?{Target AC|0}[target AC])]]}} {{Roll=[[1d20+@{str_mod}[str]+(@{melee_bonus}[wpn])-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}} {{damage=[[{@{melee_damage}[wpn]+@{str_mod}[str]+(@{class_damage_bonus}[class])-@{fatigue}[fatigue], 0d1+1}k1]]}} {{effects=@{melee_effects}}}' name='roll_melee_attack'> Attack</button>
            <input type='checkbox' name='attr_melee_equip'/>
            <input type='text' class='attackname' placeholder='Attack name...' name='attr_melee_name'/>
            <label>Bonus:</label><input type='number' min='-10' max='10' value='0' name='attr_melee_bonus'/>
            <button type='roll' value='@{whispertoggle} &{template:menu} {{title=@{banner_melee} **@{character_title} @{selected|token_name}**}} {{subtitle=Damage Roll (@{melee_name})}} {{color=red}} {{damage=[[{@{melee_damage}[wpn]+@{str_mod}[str]+(@{class_damage_bonus}[class])-@{fatigue}[fatigue], 0d1+1}k1]]}}' name='roll_melee_damage'> Dmg</button>
            <input class='width45' type='text' name='attr_melee_damage'/>
            <label>Long:</label><input type='checkbox' name='attr_melee_long'/>
            <label>Details</label>
            <input type='checkbox' class='toggle-show'/><br/>
            <div class='details'>
                <textarea placeholder='Optional Effects description...' name='attr_melee_effects'></textarea>
            </div>
        </fieldset>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Missile Attacks</label>
        <fieldset class='repeating_missile'>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_missile} **@{character_title} @{selected|token_name}**}} {{subtitle=Missile Attack (@{missile_name})}} {{color=red}} {{Target=[[@{attack_throw}+(?{Target AC|0}[target AC])]]}} {{Roll=[[1d20+@{dex_mod}[dex]+(@{missile_bonus}[wpn])+(?{Range|Short,0|Medium,-2|Long,-5}[range])+(@{class_accuracy_bonus}[class])-@{fatigue}[fatigue]+(?{Modifier|0}[mod])]]}} {{damage=[[{@{missile_damage}+(@{missile_has_str_bonus}*@{str_mod})[str]+(@{class_damage_bonus_missile}[class])-@{fatigue}[fatigue], 0d1+1}k1]]}} {{effects=@{missile_effects}}}' name='roll_missile_attack'> Attack</button>
            <input type='checkbox' name='attr_missile_equip'/>
            <input type='text' class='attackname' placeholder='Attack name...' name='attr_missile_name'/>
            <label>Bonus:</label><input type='number' value='0' name='attr_missile_bonus'/>
            <button type='roll' value='@{whispertoggle} &{template:menu} {{title=@{banner_missile} **@{character_title} @{selected|token_name}**}} {{subtitle=Damage Roll (@{missile_name})}} {{color=red}} {{damage=[[{@{missile_damage}[wpn]+(@{missile_has_str_bonus}*@{str_mod})[str]+(@{class_damage_bonus_missile}[class])-@{fatigue}[fatigue], 0d1+1}k1]]}}' name='roll_missile_damage'> Dmg</button>
            <input class='width45' type='text' name='attr_missile_damage'/>
            <label>Range:</label><input class='missilerange' type='text' name='attr_missile_range'/>
            <label>Details</label>
            <input type='checkbox' class='toggle-show'/><br/>
            <div class='details'>
                <label>Thrown</label><input type='checkbox' value='1' name='attr_missile_has_str_bonus'/>
                <textarea placeholder='Optional Effects description...' name='attr_missile_effects'></textarea>
            </div>
        </fieldset>
    </div>
    <hr/>
</div>

<div class='equipment'>
    <div class='grid11'>
        <div class='grid1111'>
            <label>Capacity, Max</label> <input type='number' value='20' name='attr_enc_capacity' readonly/>
            <label>Encumbrance</label> <input type='number' value='0' name='attr_encumbrance' readonly />
        </div>
        <div class='grid1111'> 
            <label class='redtext'>Feet / Turn</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='120' name='attr_move_turn' readonly/> 
            <label class='redtext'>Feet / Round</label> 
                <input type='hidden' class='movecheck' name='attr_move_is_zero'/>
                <input class='redmove' type='number' value='40' name='attr_move_round' readonly/>
        </div>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Equipment</label>
        <input class='toggle-show' type='checkbox' name='attr_show_equipment' checked/> show/hide
        <div class='details'>
            <fieldset class='repeating_items'>
                <input type='text' placeholder='Item name...' name='attr_item_name'/>
                <label>Weight:</label><input class='itemWeight' type='number' value='0.17' step='.01' name='attr_item_weight'/>
                <label>Count:</label><input type='number' min='0' value='1' name='attr_item_count'/>
                <label>Value:</label><input type='number' min='0' name='attr_item_value'/>
                <label>Equipped:</label><input type='checkbox' value='1' name='attr_item_equipped' checked />
                <input type='checkbox' class='toggle-show'/><br/>
                <div class='details'><textarea placeholder='Optional description...' name='attr_item_details'></textarea></div>
            </fieldset>
            <input type='hidden' value='0' name='attr_items_weight'/>
        </div>
    </div>
    <hr/>
    <div class='grid11'>
        <div class='gridcurrency'>
            <input type='hidden' value='0' name='attr_currency_weight'/>
            <label class='spanheader'>Currency</label>
            <label></label><label>On Hand</label><label>Banked</label><label>New</label><label>x:GP</label>  
            <label>PP</label>
                <input class='currency' type='number' value='0' min='0' name='attr_platinum'/>
                <input class='currency' type='number' value='0' min='0' name='attr_platinum_bank'/>
                <input class='currency' type='number' value='0' name='attr_platinum_found'/>
                <label>1:5</label>
            <label>GP</label>
                <input class='currency' type='number' value='0' min='0' name='attr_gold'/>
                <input class='currency' type='number' value='0' min='0' name='attr_gold_bank'/>
                <input class='currency' type='number' value='0' name='attr_gold_found'/>
                <label>1:1</label>
            <label>EP</label>
                <input class='currency' type='number' value='0' min='0' name='attr_electrum'/>
                <input class='currency' type='number' value='0' min='0' name='attr_electrum_bank'/>
                <input class='currency' type='number' value='0' name='attr_electrum_found'/>
                <label>2:1</label>
            <label>SP</label>
                <input class='currency' type='number' value='0' min='0' name='attr_silver'/>
                <input class='currency' type='number' value='0' min='0' name='attr_silver_bank'/>
                <input class='currency' type='number' value='0' name='attr_silver_found'/>
                <label>10:1</label>
            <label>CP</label>
                <input class='currency' type='number' value='0' min='0' name='attr_copper'/>
                <input class='currency' type='number' value='0' min='0' name='attr_copper_bank'/>
                <input class='currency' type='number' value='0' name='attr_copper_found'/>  
                <label>100:1</label>
            <label></label><label>capacity</label><label>wealth</label><label></label><label></label>
            <label></label>
            <input class='currency' type='number' value='0' name='attr_currency_capacity' readonly/>
            <input class='currency' type='number' value='0' name='attr_currency_wealth' readonly/>
            <button class='sheetbutton' type='action' name='act_claim_currency'>Claim</button>
        </div>
        <div class='grid11'>
            <label class='spanheader'>Monthly Budget</label>
            <label>Living Standard</label>
                <select name='attr_living_standard'>
                    <option value='1'>Wretched</option>
                    <option value='3'>Meager</option>
                    <option value='12' selected>Adequate</option>
                    <option value='40'>Comfortable</option>
                    <option value='100'>Prosperous</option>
                    <option value='450'>Affluent</option>
                    <option value='2000'>Sumptuous</option>
                    <option value='12000'>Luxuriant</option>
                    <option value='80000'>Lavishly Opulent</option>
                </select>
            <label>Hireling Fees</label>
                <div><input type='number' value='0' name='attr_hireling_fees' readonly/> gp</div>
            <label>Professional Income</label>
                <div><input type='number' value='0' name='attr_professional_income'/> gp</div>
            <hr class='spangrid'/>
            <label class='emphasis'>Monthly Balance</label>
                <div><input type='number' value='12' name='attr_monthly_balance' readonly/> gp</div>
        </div>
    </div>
    <hr/>
</div>

<div class='hirelings'>
    <div class='grid11'>
        <div class='grid1111'>
            <label>Henchmen Limit:</label> 
                <input type='hidden' class='henchmenCheck' name='attr_henchmen_count'/>
                <input class='limitExceeded' type='number' value='4' name='attr_henchmen_limit' readonly/> 
            <label></label><label></label>
        </div>
        <div class='grid1111'>
            <label>Hireling Fees:</label><input type='number' value='0' name='attr_hireling_fees' readonly/>
            <label></label><label></label>
        </div>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Henchmen</label>
        <fieldset class='repeating_henchmen'>
            <label>Name:</label>
                <input type='text' class='hirelingtext' name='attr_henchman_name'/>
            <label class='detailslabel'>Loyalty</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_moralecheck} **@{henchman_name}**}} {{subtitle=Loyalty Check}} {{color=brown}} {{Roll=[[2d6cs0cf0+(@{henchman_loyalty}[loyalty])+(@{cha_mod}[CHA])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Hostility&#13;3-5: Resignation&#13;6-8: Gruding Loyalty&#13;9-11: Loyalty&#13;12+: Fanatic Loyalty}}' name='roll_henchman_loyalty_check' ></button>
                <input type='number' min='-4' max='4' value='0' name='attr_henchman_loyalty'/>
            <label class='detailslabel'>Morale</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_moralecheck} **@{henchman_name}**}} {{subtitle=Obedience Check}} {{color=brown}} {{Roll=[[2d6cs0cf0+(@{henchman_morale}[morale])+(@{class_henchmen_morale_bonus}[class])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Refuses&#13;3-5: Begrudging&#13;6+: Compliant}}' name='roll_henchman_obedience_check' ></button>
                <input type='number' min='-4' max='4' value='0' name='attr_henchman_morale'/>
            <input type='checkbox' class='toggle-show' /><br/>
            <div class='details'>
                <label>Class:</label>
                    <input type='text' class='hirelingtext' name='attr_henchman_class'/>
                <label>Level:</label>
                    <input type='number' min='0' max='14' value='0' name='attr_henchman_level'/>
                <label class='detailslabel'>Wage:</label>
                    <input class='currency' type='number' value='0' name='attr_henchman_fee' readonly/>
                <textarea placeholder='Enter notes here...' name='attr_henchman_details'></textarea>
            </div>
        </fieldset>
        <input type='hidden' name='attr_henchmen_fees'/>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Mercenaries</label>
        <fieldset class='repeating_mercenaries'>
            <label>Name:</label>
                <input type='text' class='hirelingtext' name='attr_merc_name'/>
            <label>Quantity:</label>
                <input type='number' min='0' value='0' name='attr_merc_number'/>
            <label class='detailslabel'>Loyalty</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_moralecheck} **@{merc_name}**}} {{subtitle=Loyalty Check}} {{color=brown}} {{Roll=[[2d6cs0cf0+(@{merc_loyalty}[loyalty])+(@{cha_mod}[CHA])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Hostility&#13;3-5: Resignation&#13;6-8: Gruding Loyalty&#13;9-11: Loyalty&#13;12+: Fanatic Loyalty}}' name='roll_merc_loyalty_check' ></button>
                <input type='number' min='-4' max='4' value='0' name='attr_merc_loyalty'/>
            <label class='detailslabel'>Morale</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_moralecheck} **@{merc_name}**}} {{subtitle=Obedience Check}} {{color=brown}} {{Roll=[[2d6cs0cf0+(@{merc_morale}[morale])+(@{class_henchmen_morale_bonus}[class])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Refuses&#13;3-5: Begrudging&#13;6+: Compliant}}' name='roll_merc_obedience_check' ></button>
                <input type='number' min='-4' max='4' value='0' name='attr_merc_morale'/>
            <input type='checkbox' class='toggle-show' /><br/>
            <div class='details'>
                <label>Type:</label>
                    <input type='text' class='hirelingtext' name='attr_merc_type'/>
                <label>Race:</label>
                    <input type='text' class='hirelingtext' name='attr_merc_race'/>
                <label>Wage (per Troop):</label>
                    <input type='number' value='0' name='attr_merc_fee'/>
                <textarea placeholder='Enter notes here...' name='attr_merc_details'></textarea>
            </div>
        </fieldset>
        <input type='hidden' name='attr_mercenary_fees'/>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Specialists</label>
        <fieldset class='repeating_specialists'>
            <label>Name:</label>
                <input type='text' class='hirelingtext' name='attr_spec_name'/>
            <label>Type: </label>
                <input type='text' class='hirelingtext' name='attr_spec_occupation'/>
            <label class='detailslabel'>Loyalty</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_moralecheck} **@{spec_name}**}} {{subtitle=Loyalty Check}} {{color=brown}} {{Roll=[[2d6cs0cf0+(@{spec_loyalty}[loyalty])+(@{cha_mod}[CHA])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Hostility&#13;3-5: Resignation&#13;6-8: Gruding Loyalty&#13;9-11: Loyalty&#13;12+: Fanatic Loyalty}}' name='roll_spec_loyalty_check' ></button>
                <input type='number' min='-4' max='4' value='0' name='attr_spec_loyalty'/>
            <label class='detailslabel'>Morale</label>
            <button type='roll' value='@{whispertoggle} &{template:custom} {{title=@{banner_moralecheck} **@{spec_name}**}} {{subtitle=Obedience Check}} {{color=brown}} {{Roll=[[2d6cs0cf0+(@{spec_morale}[morale])+((?{Modifier|0}[mod]))]]}} {{desc=2 or less: Refuses&#13;3-5: Begrudging&#13;6+: Compliant}}' name='roll_spec_obedience_check' ></button>
                <input type='number' min='-4' max='4' value='0' name='attr_spec_morale'/>
            <input type='checkbox' class='toggle-show' /><br/>
            <div class='details'>
                <label>Wage:</label>
                    <input type='number' value='0' name='attr_spec_fee'/>
                <textarea placeholder='Enter notes here...' name='attr_spec_details'></textarea>
            </div>
        </fieldset>
        <input type='hidden' name='attr_specialist_fees'/>
    </div>
    <hr/>
</div>

<div class='journal'>
    <div>
        <label class='spanheader'>Character Background</label>
        <textarea placeholder='Enter details...' name='attr_background'></textarea>
    </div>
    <div class='grid1111'>
        <div class='journalbox'>
            <label class='spanheader'>Appearance</label>
            <textarea class='journalnotes' placeholder='Enter details...' name='attr_appearance'></textarea>
        </div>
        <div class='journalbox'>
            <label class='spanheader'>Languages</label>
            <textarea class='journalnotes' placeholder='Enter details...' name='attr_languages'>Common</textarea>
        </div>
        <div class='journalbox'>
            <label class='spanheader'>Injuries</label>
            <textarea class='journalnotes' placeholder='Enter details...' name='attr_injuries'></textarea>
        </div>
        <div class='journalbox'>
            <label class='spanheader'>Property & Debts</label>
            <textarea class='journalnotes' placeholder='Enter details...' name='attr_property'></textarea>
        </div>
    </div>
    <div>
        <label class='spanheader'>Adventuring Notes</label>
        <fieldset class='repeating_journal'>
            <label>Title: </label><input type='text' name='attr_journal_title'/>
            <label>Show Entry: </label><input type='checkbox' class='toggle-show' />
            <div class='details'><textarea placeholder='Enter details...' name='attr_journal_details'></textarea></div>
        </fieldset>
    </div>
    <hr/>
    <div>
        <label class='spanheader'>Experience Log</label>
        <fieldset class='repeating_experience'>            
            <label>Date: </label><input class='xpamount' type='text' name='attr_xp_date'/>
            <label>XP: </label><input class='xpamount' type='number' name='attr_xp_amount'/>
            <label>Bonus %: </label><input class='xpamount' type='number' name='attr_xp_bonus'/>
            <label>Note: </label><input class='xpdescription' type='text' name='attr_xp_description'/>
        </fieldset>
    </div>
    <hr/>
</div>

<div class='settings'>
    <div class='grid8'>
        <label class='spanheader'>Sheet Settings - DO NOT CHANGE</label>
        <label>Enc Threshold 1</label>
            <input type='number' min='0' value='5' name='attr_move_thresh1'/>
        <label>Enc Threshold 2</label>
            <input type='number' min='0' value='7' name='attr_move_thresh2'/>
        <label>Enc Threshold 3</label>
            <input type='number' min='0' value='10' name='attr_move_thresh3'/>
        <span></span><span></span>

        <label>Max Encumbrance</label>
            <input type='number' min='0' value='20' name='attr_base_enc'/>
        <label>Max Movement</label>
            <input type='number' min='0' value='120' name='attr_base_movement'/>
        <span></span><span></span>
        <span></span><span></span>

        <label>Experience % Modifier</label>
            <input type='number' value='0' name='attr_xp_modifier'/>
    </div>
</div>

<input type='hidden' name='attr_banner_abilitythrow' value='[x](https://s3.amazonaws.com/files.d20.io/images/240216164/eJ_5t2QOceZDGACZmtb9Mw/original.png?16291501135#.png)'/>
<input type='hidden' name='attr_banner_abilitydesc' value='[x](https://s3.amazonaws.com/files.d20.io/images/164632524/aBwd4RZHlhj38rJDw7gocg/original.png?16001823395#.png)'/>
<input type='hidden' name='attr_banner_bhr' value='[x](https://s3.amazonaws.com/files.d20.io/images/165068704/1I4pUgtI2ANx6Z1XTbB-6w/original.png?16003758415#.png)'/>
<input type='hidden' name='attr_banner_blast' value='[x](https://s3.amazonaws.com/files.d20.io/images/164351057/V_5Pg1KGLIFLY3hfmQnIAQ/original.png?16000385285#.png)'/>
<input type='hidden' name='attr_banner_climb' value='[x](https://s3.amazonaws.com/files.d20.io/images/164576947/VCDwMFLEzGxz2TIRmO8B2Q/original.png?16001420665#.png)'/>
<input type='hidden' name='attr_banner_critchar' value='[x](https://s3.amazonaws.com/files.d20.io/images/164243200/hKjALkHGX4_gj5GYWZEfmw/original.png?16000138925#.png)'/>
<input type='hidden' name='attr_banner_critmon' value='[x](https://s3.amazonaws.com/files.d20.io/images/164319112/w9iRcBuEc3vZcFvB41B2cA/original.png?16000311685#.png)'/>
<input type='hidden' name='attr_banner_hide' value='[x](https://s3.amazonaws.com/files.d20.io/images/164550402/eoU-wD5yau9lv73M0ok08g/original.png?16153950135#.png)'/>
<input type='hidden' name='attr_banner_hd' value='[x](https://s3.amazonaws.com/files.d20.io/images/240216164/eJ_5t2QOceZDGACZmtb9Mw/original.png?16291501135#.png)'/>
<input type='hidden' name='attr_banner_init' value='[x](https://s3.amazonaws.com/files.d20.io/images/240216164/eJ_5t2QOceZDGACZmtb9Mw/original.png?16291501135#.png)'/>
<input type='hidden' name='attr_banner_listen' value='[x](https://s3.amazonaws.com/files.d20.io/images/207158604/34Vzrkx7J2nxNs9STGOuzg/original.png?16153942615#.png)'/>
<input type='hidden' name='attr_banner_locks' value='[x](https://s3.amazonaws.com/files.d20.io/images/164528179/32MQFEUbgEnYE4QBpv2JkA/original.png?16001240355#.png)'/>
<input type='hidden' name='attr_banner_melee' value='[x](https://s3.amazonaws.com/files.d20.io/images/208788284/v3Vh7I66OLF3eKErbCtE8g/original.png?16159365185#.png)'/>
<input type='hidden' name='attr_banner_missile' value='[x](https://s3.amazonaws.com/files.d20.io/images/208379586/aJ7XMROQPw9EdHe_cTeuwA/original.png?16157644605#.png)'/>
<input type='hidden' name='attr_banner_morale' value='[x](https://s3.amazonaws.com/files.d20.io/images/164502952/QDUm2hoU_8YnEidHpdt3gA/original.png?16001161945#.png)'/>
<input type='hidden' name='attr_banner_moralecheck' value='[x](https://s3.amazonaws.com/files.d20.io/images/164482040/OH6hqtvCHGeesUaO0b37vQ/original.png?16001087875#.png)'/>
<input type='hidden' name='attr_banner_paralysis' value='[x](https://s3.amazonaws.com/files.d20.io/images/164446142/pUtaLtutH011f9ZjtaQgrg/original.png?16000939805#.png)'/>
<input type='hidden' name='attr_banner_pockets' value='[x](https://s3.amazonaws.com/files.d20.io/images/164543632/9HoVA3mH5HvlPZPdBqIg2g/original.png?16001284195#.png)'/>
<input type='hidden' name='attr_banner_poison' value='[x](https://s3.amazonaws.com/files.d20.io/images/164431733/S44njdUWMNsVpYVQ8O3TiA/original.png?16000843735#.png)'/>
<input type='hidden' name='attr_banner_profthrow' value='[x](https://s3.amazonaws.com/files.d20.io/images/240216164/eJ_5t2QOceZDGACZmtb9Mw/original.png?16291501135#.png)'/>
<input type='hidden' name='attr_banner_profdesc' value='[x](https://s3.amazonaws.com/files.d20.io/images/164632524/aBwd4RZHlhj38rJDw7gocg/original.png?16001823395#.png)'/>
<input type='hidden' name='attr_banner_reaction' value='[x](https://s3.amazonaws.com/files.d20.io/images/164051897/DDBz__NPDHQATVmlK4-fkw/original.png?15999466705#.png)'/>
<input type='hidden' name='attr_banner_sneak' value='[x](https://s3.amazonaws.com/files.d20.io/images/207160747/rVwt43rsKPT5fVyfg6wkhg/original.png#.png)'/>
<input type='hidden' name='attr_banner_spellcast' value='[x](https://s3.amazonaws.com/files.d20.io/images/164818577/jtP4uMJplv3U1PGD7TstAQ/original.png?16002676365#.png)'/>
<input type='hidden' name='attr_banner_spells' value='[x](https://s3.amazonaws.com/files.d20.io/images/236093721/4s45PlQQ20RYJjwZaqIQTA/original.png?16271747125#.png)'/>
<input type='hidden' name='attr_banner_staffs' value='[x](https://s3.amazonaws.com/files.d20.io/images/164818577/jtP4uMJplv3U1PGD7TstAQ/original.png?16002676365#.png)'/>
<input type='hidden' name='attr_banner_surprise' value='[x](https://s3.amazonaws.com/files.d20.io/images/207175947/Nx7GqGT7T3jyTOUgWEtb4A/original.png?16153997375#.png)'/>
<input type='hidden' name='attr_banner_traps' value='[x](https://s3.amazonaws.com/files.d20.io/images/164540585/V0d7_hhPqcsN_Paj4vVdhQ/original.png?16001276485#.png)'/>

<script type='text/worker'>
const ATTR_SCORE_DEFAULT = 10;
const BARBARIAN_SPEC_DEFAULT = 'Melee';
const BASE_AC = 11;
const COIN_WEIGHT = 0.001;
const DIE_DELIMITER = 'd';
const EMPTY_STRING = '';
const HENCHMEN_LIMIT = 4;
const LEVEL_MAX = 14;
const LEVEL_MIN = 0;
const XP_BONUS_MAX = 10;

// Button panel event handlers
const buttonlist = ['overview','combat','skills','equipment','class','hirelings','journal','settings'];
buttonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetButtons: button,
            sheetTab: button
        });
    });
});

/*************** toggle controls ****************/
// Whisper toggle
on('change:toggle_whisper', function(eventInfo) {
    /*console.log(eventInfo.sourceType + '(change:whispertoggle = ' + eventInfo.newValue + ')');*/
    const toggleValue = eventInfo.newValue.toString();
    const output = {};
    output['whispertoggle'] = (toggleValue == 'on' ? '/w gm' : EMPTY_STRING);
    setAttrs(output);
});

// Class field toggle
on('clicked:toggleLockClass', function(eventInfo) {
    getAttrs(['toggleLock_class'], function(values) {
        const theToggleState = Number(values['toggleLock_class']) || 0;

        const output = {};
        output['toggleLock_class'] = (theToggleState == 0 ? 1 : 0);
        setAttrs(output);
    });
});

// Title field toggle
on('clicked:toggleLockTitle', function(eventInfo) {
    getAttrs(['toggleLock_title'], function(values) {
        const theToggleState = Number(values['toggleLock_title']) || 0;

        const output = {};
        output['toggleLock_title'] = (theToggleState == 0 ? 1 : 0);
        setAttrs(output);
    });
});

/**************** validators ********************/

// Helpers/validation
// global helper to retrieve repeating section item ids
function getID(repeatingItemName) {
    const idStartPosition = repeatingItemName.indexOf('_',10) + 1;
    const idEndPosition = repeatingItemName.indexOf('_',idStartPosition+1);
    const theID = repeatingItemName.substring(idStartPosition, idEndPosition);
    return theID;
};

// isNumber function that returns true/false
var isNumber = function isNumber(value) 
{
   return typeof value === 'number' && isFinite(value);
}

// Sanitizes (lower case, no white space) a string
// Used for class names
function getSanitizedString(theString) {
    return theString.toLowerCase().replace(/\s/g, "")
}

// Ensures that a character's level falls within appropriate limits.
function validateLevel(theLevel) {
    let validatedLevel = parseInt(theLevel)|0;
    return validatedLevel < LEVEL_MIN ? LEVEL_MIN : validatedLevel > LEVEL_MAX ? LEVEL_MAX : validatedLevel;
};

/********** Armor Class **********/
on('change:armor change:armor_bonus change:has_shield change:class_ac_bonus change:dex_mod change:isRetreating', function(eventInfo) {
    updateArmorClass();
});

function updateArmorClass() {
    /*console.log('updateArmorClass()');*/
    getAttrs(['armor', 'armor_bonus', 'has_shield', 'class_ac_bonus', 'dex_mod'], function(values) {
        const theArmorIndex = Number(values['armor']) || 0; // base AC
        const theArmorBonus = Number(values['armor_bonus']) || 0; // magic bonus, if any
        const hasShield = Number(values['has_shield']) || 0; // shield (+1 AC)
        const classACBonus = Number(values['class_ac_bonus']) || 0; // class bonus, if any
        const theDexMod = Number(values['dex_mod']) || 0; // dex modifier

        const theAC = Math.max(0, theArmorIndex + theArmorBonus + hasShield + classACBonus + theDexMod);
        
        const output = {};
        output['armor_class'] = theAC;
        setAttrs(output);
    });
};

/********** Attribute Bonuses **********/
on('change:str change:int change:wis change:dex change:con change:cha', function(eventInfo) {
    updateAttributeBonus(eventInfo.sourceAttribute);
});

function updateAttributeBonus(theAttribute) {
    /*console.log('updateAttributeBonus(' + theAttribute + ')');*/
    getAttrs([theAttribute], function(values) {
        const attrValue = Number(values[theAttribute]) || ATTR_SCORE_DEFAULT;
        
        const modifiers = [-5,-4,-3,-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2,3,4,5]; //ACKS Core pg. 16

        const bonus = modifiers[attrValue - 1];

        const output = {};
        output[theAttribute + '_mod'] = bonus;
        setAttrs(output);
    });
};

/********** Cost of Living ****************/
on('change:living_standard change:hireling_fees change:professional_income', function(eventInfo) {
    updateCostOfLiving();
});

function updateCostOfLiving() {
    /*console.log('updateCostOfLiving()');*/
    getAttrs(['living_standard', 'hireling_fees', 'professional_income'], function(values) {
        const theLivingStandard = Number(values['living_standard']) || 0;
        const theHirelingFees = Number(values['hireling_fees']) || 0;
        const theProIncome = Number(values['professional_income']) || 0;
        
        const totalMonthlyFees = 0 - (theLivingStandard + theHirelingFees) + theProIncome;

        const output = {};
        output['monthly_balance'] = totalMonthlyFees;
        setAttrs(output);
    });
};

/********** Currency Claim **********/
on('clicked:claim_currency', function(eventInfo) {
    claimCurrency();
});

function claimCurrency() {
    /*console.log('claimCurrency()');*/
    getAttrs(['gold', 'silver', 'copper', 'electrum', 'platinum', 'gold_found', 'silver_found', 'copper_found', 'electrum_found', 'platinum_found'], function(values) {
        const coinsGold = Number(values['gold']) || 0;
        const coinsSilver = Number(values['silver']) || 0;
        const coinsCopper = Number(values['copper']) || 0;
        const coinsElectrum = Number(values['electrum']) || 0;
        const coinsPlatinum = Number(values['platinum']) || 0;
        const coinsGoldFound = Number(values['gold_found']) || 0;
        const coinsSilverFound = Number(values['silver_found']) || 0;
        const coinsCopperFound = Number(values['copper_found']) || 0;
        const coinsElectrumFound = Number(values['electrum_found']) || 0;
        const coinsPlatinumFound = Number(values['platinum_found']) || 0;

        const output = {};
        output['gold'] = coinsGold + coinsGoldFound;
        output['silver'] = coinsSilver + coinsSilverFound;
        output['copper'] = coinsCopper + coinsCopperFound;
        output['electrum'] = coinsElectrum + coinsElectrumFound;
        output['platinum'] = coinsPlatinum + coinsPlatinumFound;
        output['gold_found'] = output['silver_found'] = output['copper_found'] = output['electrum_found'] = output['platinum_found'] = 0;
        setAttrs(output);
    });
};

/********** Currency Wealth **********/
on('change:gold change:silver change:copper change:electrum change:platinum change:gold_bank change:silver_bank change:copper_bank change:electrum_bank change:platinum_bank', function(eventInfo) {
    updateCurrencyWealth();
});

function updateCurrencyWealth() {
    /*console.log('updateCurrencyWealth()');*/
    getAttrs(['gold', 'silver', 'copper', 'electrum', 'platinum', 'gold_bank', 'silver_bank', 'copper_bank', 'electrum_bank', 'platinum_bank'], function(values) {
        const coinsGold = Number(values['gold']) || 0;
        const coinsSilver = Number(values['silver']) || 0;
        const coinsCopper = Number(values['copper']) || 0;
        const coinsElectrum = Number(values['electrum']) || 0;
        const coinsPlatinum = Number(values['platinum']) || 0;
        const coinsGoldBank = Number(values['gold_bank']) || 0;
        const coinsSilverBank = Number(values['silver_bank']) || 0;
        const coinsCopperBank = Number(values['copper_bank']) || 0;
        const coinsElectrumBank = Number(values['electrum_bank']) || 0;
        const coinsPlatinumBank = Number(values['platinum_bank']) || 0;
        
        const totalWealth = 
            Math.floor((
            coinsGold*100 +  
            coinsSilver*10 + 
            coinsCopper +
            coinsElectrum*50 +
            coinsPlatinum*500 +
            coinsGoldBank*100 + 
            coinsSilverBank*10 + 
            coinsCopperBank +
            coinsElectrumBank*50 +
            coinsPlatinumBank*500
            )/100); // Convert all to copper, then back to gold

        const output = {};
        output['currency_wealth'] = totalWealth;
        setAttrs(output);
    });
};

/********** Currency Weight **********/
on('change:gold change:silver change:copper change:electrum change:platinum change:gold_found change:silver_found change:copper_found change:electrum_found change:platinum_found', function(eventInfo) {
    updateCurrencyWeight();
});

function updateCurrencyWeight() {
    /*console.log('updateCurrencyWeight()');*/
    getAttrs(['gold', 'silver', 'copper', 'electrum', 'platinum', 'gold_found', 'silver_found', 'copper_found', 'electrum_found', 'platinum_found'], function(values) {
        const coinsGold = Number(values['gold']) || 0;
        const coinsSilver = Number(values['silver']) || 0;
        const coinsCopper = Number(values['copper']) || 0;
        const coinsElectrum = Number(values['electrum']) || 0;
        const coinsPlatinum = Number(values['platinum']) || 0;
        const coinsGoldFound = Number(values['gold_found']) || 0;
        const coinsSilverFound = Number(values['silver_found']) || 0;
        const coinsCopperFound = Number(values['copper_found']) || 0;
        const coinsElectrumFound = Number(values['electrum_found']) || 0;
        const coinsPlatinumFound = Number(values['platinum_found']) || 0;
        
        const totalCoins = 
            coinsGold + 
            coinsSilver + 
            coinsCopper + 
            coinsElectrum + 
            coinsPlatinum +
            coinsGoldFound + 
            coinsSilverFound + 
            coinsCopperFound + 
            coinsElectrumFound + 
            coinsPlatinumFound;
        const totalWeight = totalCoins * COIN_WEIGHT;

        const output = {};
        output['currency_weight'] = totalWeight;
        setAttrs(output);
    });
};

/********** Currency, Found XP **********/
on('change:gold_found change:silver_found change:copper_found change:electrum_found change:platinum_found', function(eventInfo) {
    updateCurrencyXP();
});

function updateCurrencyXP() {
    /*console.log('updateCurrencyXP()');*/
    getAttrs(['gold_found', 'silver_found', 'copper_found', 'electrum_found', 'platinum_found'], function(values) {
        const coinsGoldFound = Number(values['gold_found']) || 0;
        const coinsSilverFound = Number(values['silver_found']) || 0;
        const coinsCopperFound = Number(values['copper_found']) || 0;
        const coinsElectrumFound = Number(values['electrum_found']) || 0;
        const coinsPlatinumFound = Number(values['platinum_found']) || 0;
        
        const totalXP = 
            Math.floor((
            coinsGoldFound*100 +
            coinsSilverFound*10 + 
            coinsCopperFound +
            coinsElectrumFound*50 +
            coinsPlatinumFound*500
            )/100); // Convert all to copper, then back to gold

        const output = {};
        output['currency_xp'] = totalXP;
        setAttrs(output);
    });
};

/********** Encumbrance **********/
on('change:currency_weight change:items_weight change:enc_capacity', function(eventInfo) {
    updateEncumbrance();
});

function updateEncumbrance() {
    /*console.log('updateEncumbrance()');*/
    getAttrs(['currency_weight', 'items_weight', 'enc_capacity'], function(values) {
        const theCurrencyWeight = Number(values['currency_weight']) || 0;
        const theItemWeight = Number(values['items_weight']) || 0;
        const theMaxCapacity = Number(values['enc_capacity']) || 0;
        
        const theEncumbrance = theCurrencyWeight + theItemWeight;
        const theCurrencyCapacity = (theMaxCapacity - theEncumbrance) / COIN_WEIGHT;

        const output = {};
        output['encumbrance'] = Math.ceil(theEncumbrance);
        output['currency_capacity'] = Math.ceil(theCurrencyCapacity);
        setAttrs(output);
    });
};

/********** Encumbrance Capacity **********/
on('change:str_mod change:base_enc', function(eventInfo) {
    updateEncumbranceCapacity();
});

function updateEncumbranceCapacity() {
    /*console.log('updateEncumbranceCapacity()');*/
    getAttrs(['str_mod', 'base_enc'], function(values) {
        const strMod = Number(values['str_mod']) || 0;
        const baseEnc = Number(values['base_enc']) || 0;

        let encCapacity = baseEnc + strMod;

        const output = {};
        output['enc_capacity'] = encCapacity;
        setAttrs(output);
    });
};

/********** Experience Points **********/
on('change:repeating_experience:xp_amount change:repeating_experience:xp_bonus remove:repeating_experience', function(eventInfo) {
    updateTotalExperience();
});

function updateTotalExperience() {
    /*console.log('updateTotalExperience()');*/

    getSectionIDs('repeating_experience', function (ids) {
        const XPFieldnames = [];
        ids.forEach(id => {
            XPFieldnames.push('repeating_experience_' + id + '_xp_amount');
            XPFieldnames.push('repeating_experience_' + id + '_xp_bonus');
        });
        
        getAttrs([...XPFieldnames], function (values) {
            let totalXP = 0;
            const output = {};
            ids.forEach(id => {
                const itemXP = parseFloat(values['repeating_experience_' + id + '_xp_amount'])||0;
                const xpBonus = parseFloat(values['repeating_experience_' + id + '_xp_bonus'])||0;
                totalXP += Math.floor(itemXP + (itemXP * (xpBonus / 100)));
            });
            output['xp'] = totalXP;
            setAttrs(output);
        });
    });
};

/************* Fatigue *****************/
on('change:fatigue', function(eventInfo) {
    updateFatigue();
});

function updateFatigue() {
    /*console.log('updateFatigue()');*/

    getAttrs(['fatigue'], function (values) {
        const fatigueLevel = Number(values['fatigue']) || 0;

        const output = {};
        output['is_fatigued'] = (fatigueLevel > 0 ? 1 : 0);
        setAttrs(output);
    });
}


/********** Fees **********/
on('change:repeating_henchmen:henchman_fee remove:repeating_henchmen', function(eventInfo) {
    updateHenchmenFees();
});

function updateHenchmenFees() {
    /*console.log('updateHenchmenFees()');*/

    getSectionIDs('repeating_henchmen', function (ids) {
        const feeHenchFieldnames = [];
        ids.forEach(id => {
            feeHenchFieldnames.push('repeating_henchmen_' + id + '_henchman_fee');
        });
        
        getAttrs([...feeHenchFieldnames], function (values) {
            let totalFees = 0;
            const output = {};
            ids.forEach(id => {
                const itemFee = parseFloat(values['repeating_henchmen_' + id + '_henchman_fee'])||0;
                totalFees += itemFee;
            });
            output['henchmen_fees'] = totalFees;
            setAttrs(output);
        });
    });
};

on('change:repeating_mercenaries:merc_fee change:repeating_mercenaries:merc_number remove:repeating_mercenaries', function(eventInfo) {
    updateMercenaryFees();
});

function updateMercenaryFees() {
    /*console.log('updateMercenaryFees()');*/

    getSectionIDs('repeating_mercenaries', function (ids) {
        const feeMercFieldnames = [];
        const numMercFieldnames = [];
        ids.forEach(id => {
            feeMercFieldnames.push('repeating_mercenaries' + id + '_merc_fee');
            numMercFieldnames.push('repeating_mercenaries' + id + '_merc_number');
        });
        
        getAttrs([...feeMercFieldnames, ...numMercFieldnames], function (values) {
            let totalFees = 0;
            const output = {};
            ids.forEach(id => {
                const itemFee = parseFloat(values['repeating_mercenaries' + id + '_merc_fee'])||0;
                const itemNum = parseFloat(values['repeating_mercenaries' + id + '_merc_number'])||0;                
                totalFees += itemFee * itemNum;
            });
            output['mercenary_fees'] = totalFees;
            setAttrs(output);
        });
    });
};

on('change:repeating_specialists:spec_fee remove:repeating_specialists', function(eventInfo) {
    updateSpecialistFees();
});

function updateSpecialistFees() {
    /*console.log('updateSpecialistFees()');*/

    getSectionIDs('repeating_specialists', function (ids) {
        const feeSpecFieldnames = [];
        ids.forEach(id => {
            feeSpecFieldnames.push('repeating_specialists' + id + '_spec_fee');
        });
        
        getAttrs([...feeSpecFieldnames], function (values) {
            let totalFees = 0;
            const output = {};
            ids.forEach(id => {
                const itemFee = parseFloat(values['repeating_specialists' + id + '_spec_fee'])||0;
                totalFees += itemFee;
            });
            output['specialist_fees'] = totalFees;
            setAttrs(output);
        });
    });
};

on('change:henchmen_fees change:mercenary_fees change:specialist_fees', function(eventInfo) {
    updateHirelingFees();
});

function updateHirelingFees() {
    /*console.log('updateHirelingFees()');*/
        
    getAttrs(['henchmen_fees', 'mercenary_fees', 'specialist_fees'], function (values) {
        const theHenchmenFees = Number(values['henchmen_fees']) || 0;
        const theMercenaryFees = Number(values['mercenary_fees']) || 0;
        const theSpecialistFees = Number(values['specialist_fees']) || 0;

        const output = {};
        output['hireling_fees'] = theHenchmenFees + theMercenaryFees + theSpecialistFees;
        setAttrs(output);
    });
};

/********** Henchmen Limit **********/
on('change:cha_mod', function(eventInfo) {
    updateHenchmenLimit();
});

function updateHenchmenLimit() {
    /*console.log('updateHenchmenLimit()');*/
    getAttrs(['cha_mod'], function(values) {
        const chaMod = Number(values['cha_mod']) || 0;
        
        const output = {};
        output['henchmen_limit'] = HENCHMEN_LIMIT + chaMod;
        setAttrs(output);
    });
};

/********** Henchmen Limit Check **********/
on('change:repeating_henchmen:henchman_name remove:repeating_henchmen change:henchmen_limit', function(eventInfo) {
    countHenchmen();
});

function countHenchmen() {
    /*console.log('countHenchmen()');*/
    getAttrs(['henchmen_limit'], function(values) {
        const henchmenLimit = Number(values['henchmen_limit']) || HENCHMEN_LIMIT;

        getSectionIDs('repeating_henchmen', function (ids) {
            const numHenchmen = ids.length;
            
            const output = {};
            output['henchmen_count'] = (numHenchmen > henchmenLimit ? 1: 0);
            setAttrs(output);
        });
    });
};

/********** Henchman Fee **************/
on('change:repeating_henchmen:henchman_level', function(eventInfo) {
    updateHenchmanFee(getID(eventInfo.sourceAttribute), eventInfo.newValue);
});

function updateHenchmanFee(theRowId, theLevel) {
    /*console.log('updateHenchmanFee(' + theRowId + ',' + theLevel + ')');*/

    const henchmenFees = [12,25,50,100,200,400,800,1600,3000,7250,12000,32000,50000,135000,350000];
    
    const output = {};
    output['repeating_henchmen_' + theRowId + '_henchman_fee'] = henchmenFees[theLevel];
    setAttrs(output);
};

/********** Hit Die, Set **********/
on('change:hit_dice', function(eventInfo) {
    if (eventInfo.sourceType == "player") {
        getAttrs(['hit_dice'], function(values) {
            const output = {};
            output['hit_dice'] = validateHitDice(values['hit_dice']); 
            setAttrs(output);
        });
    }
});

function validateHitDice(theHitDice) {
    /*console.log('validateHitDice(' + theHitDice + ')');*/

    const theDelimiter = theHitDice.toLowerCase().indexOf(DIE_DELIMITER);
    if (theDelimiter == -1) return EMPTY_STRING; // bad string    
    const numberOfHitDice = theHitDice.substr(0,theDelimiter);
    if (isNaN(numberOfHitDice)) return EMPTY_STRING; // bad string
    const restOfString = theHitDice.substr(theDelimiter + 1);
    const theOperator = restOfString.indexOf('+') > -1 ? restOfString.indexOf('+') : restOfString.indexOf('-') > -1 ? restOfString.indexOf('-') : -1;
    const numSides = theOperator != -1 ? restOfString.substr(0,theOperator) : restOfString;
    if (isNaN(numSides)) return EMPTY_STRING; // bad string
    const modValue = theOperator != -1 ? restOfString.substr(theOperator + 1) : 0;
    if (isNaN(modValue)) return EMPTY_STRING; // bad string  
    
    // All tests passed = set hit die and temp HD
    const output = {};
    output['hit_die'] = DIE_DELIMITER + numSides; 
    output['temp_hd'] = numberOfHitDice; 
    setAttrs(output);

    return theHitDice;
};

/********** Hit Point Check/Validation **********/
on('change:hp', function(eventInfo) {
    if (eventInfo.sourceType == "player") validateHitPoints(); 
});

function validateHitPoints() {
    /*console.log('validateHitPoints()');*/
    getAttrs(['hp', 'hp_max'], function(values) {
        const theHP = parseInt(values['hp']) || 0;
        const theHPMax = parseInt(values['hp_max']) || 0;

        const validatedHP = theHP > theHPMax ? theHPMax : theHP;

        const output = {};
        //output['hp'] = validatedHP;
        output['hp_is_below_one'] = (validatedHP < 1 ? 1 : 0);
        setAttrs(output);
    });
};

/********** Items **********/
on('change:repeating_items:item_weight change:repeating_items:item_count change:repeating_items:item_equipped remove:repeating_items', function(eventInfo) {
    if (eventInfo.sourceType == "player") updateItemEncumbrance(
        'repeating_items', 
        '_item_weight',
        '_item_count',
        '_item_equipped',
        'items_weight'
        );
});

function updateItemEncumbrance(
    repeatingName, 
    encPropName,
    countPropName,
    equippedPropName,
    outputName) {
    /*console.log('updateItemEncumbrance(' + repeatingName + ', ' + encPropName + ', ' + countPropName + ', ' + outputName + ')');*/
    getSectionIDs(repeatingName, function (ids) {
        const encFieldnames = [];
        const countFieldnames = [];
        const equippedFieldnames = [];
        ids.forEach(id => {
            encFieldnames.push(repeatingName + '_' + id + encPropName);
            countFieldnames.push(repeatingName + '_' + id + countPropName);
            equippedFieldnames.push(repeatingName + '_' + id + equippedPropName);
        });
        
        getAttrs([...encFieldnames, ...countFieldnames, ...equippedFieldnames], function (values) {
            const output = {};
            let totalEnc = 0;
            ids.forEach(id => {
                const itemEnc = parseFloat(values[repeatingName + '_' + id + encPropName]);
                const itemCount = parseFloat(values[repeatingName + '_' + id + countPropName])||0;
                const equipped = parseInt(values[repeatingName + '_' + id + equippedPropName]);

                totalEnc += equipped == 1 ? itemEnc * itemCount : 0;
            });
            output[outputName] = totalEnc;
            setAttrs(output);
        });
    });
};

/********** Movement Speed **********/
on('change:enc_capacity change:encumbrance change:base_movement change:move_thresh1 change:move_thresh2 change:move_thresh3', function(eventInfo) {
    updateMovementSpeed();
});

function updateMovementSpeed() {
    /*console.log('updateMovementSpeed()');*/
    getAttrs(['enc_capacity', 'encumbrance', 'base_movement', 'move_thresh1', 'move_thresh2', 'move_thresh3'], function(values) {
        const encCapacity = Number(values['enc_capacity']) || 0; // how much can be carried?
        const theEncumbrance = Number(values['encumbrance']) || 0; // how much is being carried?
        const movementBase = Number(values['base_movement']) || 0; // base movement
        const moveThresh1 = Number(values['move_thresh1']) || 0; // movement threshold
        const moveThresh2 = Number(values['move_thresh2']) || 0; // movement threshold
        const moveThresh3 = Number(values['move_thresh3']) || 0; // movement threshold

        const moveThresholds = [(moveThresh1 + .01),(moveThresh2 + .01),(moveThresh3 + .01),encCapacity+.01,999];
        const moveThresholdIndex = moveThresholds.findIndex(element => theEncumbrance < element);

        const moveSpeeds = [movementBase,(movementBase * .75),(movementBase * .5),(movementBase * .25),0]; //ACKS Core, pg. 48
        const theMovementSpeed = moveSpeeds[moveThresholdIndex];
        const isMovementZero = theMovementSpeed > 0 ? 0 : 1;
        
        const output = {};
        output['move_turn'] = Math.round(theMovementSpeed);
        output['move_round'] = Math.round(theMovementSpeed / 3);
        output['miles_day'] = Math.round(theMovementSpeed / 5);
        output['miles_hour'] = theMovementSpeed / 40;
        output['move_is_zero'] = isMovementZero;
        setAttrs(output);
    });
};

/********** Saving Throws (Monsters) **********/
on('change:monster_save', function(eventInfo) {
    updateMonsterSaves();
});

function updateMonsterSaves() {
    console.log('updateMonsterSaves()');
    getAttrs(['monster_save'], function(values) {
        const saveString = values['monster_save'];
        
        const clericSaves = [14,15,16,17,18,13,10,16,13,15,13,10,16,13,15,12,9,15,12,14,12,9,15,12,14,11,8,14,11,13,11,8,14,11,13,10,7,13,10,12,10,7,13,10,12,9,6,12,9,11,9,6,12,9,11,8,5,11,8,10,8,5,11,8,10,7,4,10,7,9,7,4,10,7,9,6,3,9,6,8,6,3,9,6,8,5,2,8,5,7,5,2,8,5,7,4,1,7,4,6,4,1,7,4,6];
        const dwarvenvaultguardSaves = [14,15,16,17,18,9,10,12,12,13,8,9,11,11,12,8,9,11,11,12,7,8,10,10,11,6,7,9,9,10,6,7,9,9,10,5,6,8,8,9,4,5,7,7,8,4,5,7,7,8,3,4,6,6,7,2,3,5,5,6,2,3,5,5,6,1,2,4,4,5,0,1,3,3,4,0,1,3,3,4,-1,0,2,2,3,-2,-1,1,1,2,-2,-1,1,1,2,-3,-2,0,0,1,-4,-3,-1,-1,0];
        const elvenspellsword = [14,15,16,17,18,12,14,15,16,16,11,13,14,15,15,11,13,14,15,15,10,12,13,14,14,9,11,12,13,13,9,11,12,13,13,8,10,11,12,12,7,9,10,11,11,7,9,10,11,11,6,8,9,10,10,5,7,8,9,9,5,7,8,9,9,4,6,7,8,8,3,5,6,7,7,3,5,6,7,7,2,4,5,6,6,1,3,4,5,5,1,3,4,5,5,0,2,3,4,4,-1,1,2,3,3];
        const fighterSaves = [14,15,16,17,18,13,14,15,16,17,12,13,14,15,16,12,13,14,15,16,11,12,13,14,15,10,11,12,13,14,10,11,12,13,14,9,10,11,12,13,8,9,10,11,12,8,9,10,11,12,7,8,9,10,11,6,7,8,9,10,6,7,8,9,10,5,6,7,8,9,4,5,6,7,8,4,5,6,7,8,3,4,5,6,7,2,3,4,5,6,2,3,4,5,6,1,2,3,4,5,0,1,2,3,4];
        const mageSaves = [14,15,16,17,18,13,13,15,11,12,13,13,15,11,12,13,13,15,11,12,12,12,14,10,11,12,12,14,10,11,12,12,14,10,11,11,11,13,9,10,11,11,13,9,10,11,11,13,9,10,10,10,12,8,9,10,10,12,8,9,10,10,12,8,9,9,9,11,7,8,9,9,11,7,8,9,9,11,7,8,8,8,10,6,7,8,8,10,6,7,8,8,10,6,7,7,7,9,5,6,7,7,9,5,6];
        const thiefSaves = [14,15,16,17,18,13,13,13,14,15,13,13,13,14,15,12,12,12,13,14,12,12,12,13,14,11,11,11,12,13,11,11,11,12,13,10,10,10,11,12,10,10,10,11,12,9,9,9,10,11,9,9,9,10,11,8,8,8,9,10,8,8,8,9,10,7,7,7,8,9,7,7,7,8,9,6,6,6,7,8,6,6,6,7,8,5,5,5,6,7,5,5,5,6,7,4,4,4,5,6,4,4,4,5,6];

        const saveClass = saveString.substr(0,1);
        const saveLevel = Math.max(Math.min(Number(saveString.substr(1,2)) || 0,20),0);

        let appliedSaves = [];
        switch (saveClass) { 
            case 'C': appliedSaves = clericSaves; break;
            case 'D': appliedSaves = dwarvenvaultguardSaves; break;
            case 'E': appliedSaves = elvenspellsword; break;
            case 'F': appliedSaves = fighterSaves; break;
            case 'M': appliedSaves = mageSaves; break;
            case 'T': appliedSaves = thiefSaves; break;
            default: return;
        }
        
        const output = {};
        for (var i = 0; i < 5; i++ ) { output['save_' + (i + 1)] = appliedSaves[(saveLevel) * 5 + i]};
        setAttrs(output);
    });
};

/********** Spells Reset **********/
on('clicked:reset_spells', function(eventInfo) {
    updateSpellcasting();
});

function updateSpellcasting() {
    /*console.log('updateSpellcasting()');*/
    getAttrs(['spells_1_max', 'spells_2_max', 'spells_3_max', 'spells_4_max', 'spells_5_max', 'spells_6_max', 'spells_7_max', 'spells_8_max', 'spells_9_max'], function(values) {
        const spells1 = Number(values['spells_1_max']) || 0;
        const spells2 = Number(values['spells_2_max']) || 0;
        const spells3 = Number(values['spells_3_max']) || 0;
        const spells4 = Number(values['spells_4_max']) || 0;
        const spells5 = Number(values['spells_5_max']) || 0;
        const spells6 = Number(values['spells_6_max']) || 0;
        const spells7 = Number(values['spells_7_max']) || 0;
        const spells8 = Number(values['spells_8_max']) || 0;
        const spells9 = Number(values['spells_9_max']) || 0;

        const output = {};
        output['spells_1'] = spells1;
        output['spells_2'] = spells2;
        output['spells_3'] = spells3;
        output['spells_4'] = spells4;
        output['spells_5'] = spells5;
        output['spells_6'] = spells6;
        output['spells_7'] = spells7;
        output['spells_8'] = spells8;
        output['spells_9'] = spells9;
        setAttrs(output);
    });
};

/********** XP Bonus **********/
on('change:str change:int change:wis change:dex change:con change:cha change:str_pre change:int_pre change:wis_pre change:dex_pre change:con_pre change:cha_pre change:xp_modifier', function(eventInfo) {
    calculateXPBonus();
});

function calculateXPBonus() {
    /*console.log('calculateXPBonus()');*/
    getAttrs(['str', 'int', 'wis', 'dex', 'con', 'cha', 'str_pre', 'int_pre', 'wis_pre', 'dex_pre', 'con_pre', 'cha_pre', 'xp_modifier'], function(values) {
        const attributes = [values['str'],values['int'],values['wis'],values['dex'],values['con'],values['cha']];
        const prerequisites = [values['str_pre'],values['int_pre'],values['wis_pre'],values['dex_pre'],values['con_pre'],values['cha_pre']];
        const theModifier = Number(values['xp_modifier']) || 0;
        
        const output = {};
        let theBonus = XP_BONUS_MAX;
        let noPrereq = 1;
        for (var i = 0; i < 6; i++) {
            if (prerequisites[i] == 'on') {
                theBonus = Math.min(theBonus,(attributes[i] > 15 ? 10 : (attributes[i] > 12 ? 5 : 0)));
                noPrereq = 0;
            }
        }
        output['xp_bonus'] = (noPrereq == 1 ? 0 : (theBonus + theModifier));
        setAttrs(output); 
    });
};

</script>

<rolltemplate class="sheet-rolltemplate-custom">
    <div class="sheet-container sheet-color-{{color}}">
      <div class="sheet-header">
        {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
        {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
      </div>
      <div class="sheet-content">
        {{#allprops() title subtitle color damage desc effects loyalty surprise}}
        <div class="sheet-key">{{key}}</div>
        <div class="sheet-value">{{value}}</div>
        {{/allprops() title subtitle color damage desc effects loyalty surprise}}
        
        {{#effects}}
        <div class="sheet-key">Effects</div>
        <div class="sheet-value">{{effects}}</div>
        {{/effects}}

        {{#^rollLess() Roll Target}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="success">Success!</span></div>
            {{#damage}}
            <div class="sheet-key">Damage</div>
            <div class="sheet-value">{{damage}}</div>
            {{/damage}}
        {{/^rollLess() Roll Target}}
        {{#rollLess() Roll Target}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="failure">Failure!</span></div>
        {{/rollLess() Roll Target}}

        {{#rollLess() Surprise 3}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="failure">Surprised!</span></div>
        {{/rollLess() Surprise 3}}
        {{#^rollLess() Surprise 3}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="success">Unsurprised!</span></div>
        {{/^rollLess() Surprise 3}}

        {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
      </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-menu">
    <div class="sheet-container sheet-color-{{color}}">
         <div class="sheet-header">
            {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
            {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
        </div>
         <div class="sheet-content">
            {{#allprops() title subtitle desc color}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
            {{/allprops() title subtitle desc color}}
            {{#desc}}
                <div class="sheet-desc">{{desc}}</div>
            {{/desc}}
        </div>
    </div>
</rolltemplate>